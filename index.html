<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!--
        Content Security Policy (CSP)
        This policy enhances security by restricting where resources (like scripts and styles) can be loaded from.
        - default-src 'self': By default, only allow resources from the same origin.
        - script-src 'self' 'unsafe-inline' blob:: Allows scripts from the same origin, inline scripts, and blob URLs.
          'blob:' is required for Plotly.js WebGL charts (like pair plots) to work correctly.
        - style-src 'self' 'unsafe-inline' data:: Allows stylesheets from the same origin, inline styles, and data URIs.
          'data:' is added for broader compatibility with dynamically generated styles.
        - img-src 'self' data: https://allisonhorst.github.io: Allow images from the same origin, data URIs, and the palmerpenguins logo source.
        - object-src 'none': Disallow plugins like Flash.
        - frame-ancestors 'none': Prevent the page from being embedded in an iframe.
    -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
        script-src 'self' 'unsafe-inline' blob:;
        style-src 'self' 'unsafe-inline' blob:;
        worker-src 'self' blob:;
        img-src 'self' blob:;
        object-src 'none';
        frame-ancestors 'none';">

    <title data-lang-key="pageTitle">HakoHigeKun-R - Your Personal Offline Box-and-Whisker Plotter</title>
    <!--
        HakoHigeKun-R
        Copyright (c) 2025 btklab
        Licensed under the MIT License
    
        This app includes third-party libraries and sample datasets:

          Libraries:
            - Tailwind CSS (MIT)
            - Plotly.js (MIT)
            - PapaParse (MIT)
            - SheetJS/xlsx (MIT-compatible)

          Sample Data:
            - "palmerpenguins" dataset
              Source: https://github.com/allisonhorst/palmerpenguins
              License: CC0 1.0 (Public Domain)
    -->

    <!--
        Subresource Integrity (SRI) - Security Recommendation
        If these libraries were hosted on a CDN, it would be best practice to add an 'integrity' attribute.
        This ensures the file hasn't been tampered with.
        Example: <script src="https://example.com/library.js" integrity="sha256-hashvalue" crossorigin="anonymous"></script>
        Since these are local files, SRI is not applicable, but it's important to be aware of for web deployment.

            @{ Url = "https://cdn.tailwindcss.com"; Out = "tailwindcss.js" },
            @{ Url = "https://cdn.plot.ly/plotly-2.32.0.min.js"; Out = "plotly-2.32.0.min.js" },
            @{ Url = "https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"; Out = "papaparse.min.js" },
            @{ Url = "https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"; Out = "xlsx.full.min.js" }

            openssl dgst -sha384 -binary plotly-2.32.0.min.js | openssl base64 -A
    -->
    <script src="libs/tailwindcss.js"></script>
    <script src="libs/plotly-2.32.0.min.js"></script>
    <script src="libs/papaparse.min.js"></script>
    <script src="libs/xlsx.full.min.js"></script>
    <style>
        /* Custom Styles: Adjust sidebar width and main content */
        .sidebar {
            width: 320px;
            min-width: 320px;
        }
        .main-content {
            flex-grow: 1;
        }
        /* Set height for the Plotly chart container */
        #chart-container {
            min-height: 600px;
        }
        /* Style the scrollbar for better visibility */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* slate-300 */
            border-radius: 4px;
        }
        /* Sticky headers and labels for the summary statistics table */
        #summary-statistics-container th, 
        #summary-statistics-container .sticky-stat-label {
            position: sticky;
            z-index: 10;
        }
        #summary-statistics-container th {
            top: 0;
        }
        #summary-statistics-container .sticky-stat-label {
            left: 0;
            background-color: white; /* Set background to white for visibility on horizontal scroll */
            border-right: 1px solid #e5e7eb; /* Add a border line */
        }
        .lang-btn.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            font-weight: bold;
        }
        /* ======================================= */
        /* === Print Styles === */
        /* ======================================= */
        @media print {
            .sidebar, header, button, .hidden-print, .language-switcher { display: none !important; }
            .main-container { display: block !important; }
            .main-content, #chart-area { width: 100% !important; max-width: 100% !important; padding: 0 !important; margin: 0 !important; }
            #chart-container { min-height: auto !important; height: auto !important; width: 100% !important; }
            body { background-color: white !important; color: black !important; }
            .shadow-lg, .rounded-xl { box-shadow: none !important; border-radius: 0 !important; }
        }
</style>
</head>
<body class="bg-gray-50 flex h-screen overflow-hidden text-gray-800 font-sans">

    <div class="sidebar bg-white p-6 shadow-xl overflow-y-auto">
        <h1 class="text-3xl font-extrabold text-blue-700 mb-2 border-b pb-2">
            <span data-lang-key="appTitle" onclick="location.reload()" style="cursor: pointer;" data-lang-key-title="refreshTitle">📊 箱ひげくん-R</span>
        </h1>

        <div class="language-switcher flex justify-end items-center mb-4">
            <button onclick="location.reload()" class="text-xs py-1 px-3 rounded-md border border-gray-300 bg-gray-50 hover:bg-gray-100 mr-2" data-lang-key="refreshButton" data-lang-key-title="refreshTitle">Refresh</button>
            <div>
                <button onclick="setLanguage('ja')" class="lang-btn text-xs py-1 px-3 rounded-l-lg border border-gray-300" data-lang="ja">日本語</button>
                <button onclick="setLanguage('en')" class="lang-btn text-xs py-1 px-3 rounded-r-lg border-t border-b border-r border-gray-300" data-lang="en">English</button>
            </div>
        </div>
        
        <div class="mb-8">
            <h2 class="text-xl font-semibold mb-3 text-gray-700" data-lang-key="fileUploadTitle">📤 ファイルアップロード</h2>
            <div class="p-4 border-2 border-dashed border-gray-300 rounded-lg bg-blue-50">
                <label for="file-input" class="block text-sm font-medium text-gray-700 mb-2" data-lang-key="fileUploadLabel">データファイルを選択、またはドラッグ＆ドロップ(*.xlsx, *.csv)</label>
                <input type="file" id="file-input" accept=".csv, .xlsx, .xls" class="w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-full file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-500 file:text-white
                    hover:file:bg-blue-600
                ">
                <p id="file-status" class="mt-2 text-sm text-green-600 font-medium hidden"></p>
            </div>
            <div class="mt-4 text-center">
                <p class="text-sm text-gray-500 mb-2" data-lang-key="orText">または</p>
                <button onclick="loadSampleData()" class="w-full inline-flex items-center justify-center py-2 px-4 bg-teal-500 text-white font-semibold rounded-lg shadow-md hover:bg-teal-600 transition duration-150 transform hover:scale-[1.01]">
                    <!--
                    <img src="https://allisonhorst.github.io/palmerpenguins/logo.png" alt="Palmer Penguins Logo" class="w-6 h-6 mr-2">
                    -->
                    <span data-lang-key="sampleDataButton">サンプルデータを読み込む</span>
                </button>
            </div>
        </div>

        <div id="chart-settings" class="mb-8 hidden">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2" data-lang-key="chartSettingsTitle">⚙️ グラフの設定</h2>
            
            <label for="chart-type-select" class="block text-sm font-medium text-gray-700 mb-2" data-lang-key="chartTypeLabel">グラフの種類を選択</label>
            <select id="chart-type-select" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500 mb-4">
            </select>

            <div id="chart-config-area" class="space-y-4 p-4 border border-gray-200 rounded-lg bg-white shadow-inner">
                <p class="text-gray-500 italic" data-lang-key="chartConfigPlaceholder">データを選択し、グラフの種類を選ぶと設定が表示されます。</p>
            </div>
            
            <div class="mt-4">
                <label for="chart-title" class="block text-sm font-medium text-gray-700" data-lang-key="chartTitleLabel">グラフタイトル</label>
                <input type="text" id="chart-title" 
                    class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out"
                    data-lang-key-placeholder="chartTitlePlaceholder">
            </div>

            <button onclick="drawChart()" id="draw-chart-button" class="mt-6 w-full py-3 px-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg hover:bg-blue-700 transition duration-150 transform hover:scale-[1.01] disabled:bg-gray-400" disabled>
                <span data-lang-key="drawChartButton">🚀 グラフを描画</span>
            </button>
        </div>

        <a href="https://github.com/btklab/HakoHigeKun-R" target="_blank" class="flex items-center hover:text-gray-400 font-medium text-gray-400">
            <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 24 24">
                <path fill-rule="evenodd" clip-rule="evenodd"
                    d="M12 0C5.37 0 0 5.37 0 12c0 5.303 3.438 9.8 8.205 11.387.6.113.82-.26.82-.577v-2.234c-3.338.726-4.033-1.415-4.033-1.415-.546-1.387-1.334-1.756-1.334-1.756-1.09-.745.082-.73.082-.73 1.205.085 1.84 1.237 1.84 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.304.762-1.604-2.665-.304-5.467-1.333-5.467-5.93 0-1.31.468-2.381 1.235-3.22-.124-.303-.536-1.524.117-3.176 0 0 1.008-.322 3.3 1.23a11.52 11.52 0 0 1 3-.404c1.02.005 2.045.137 3 .404 2.29-1.552 3.296-1.23 3.296-1.23.655 1.653.243 2.874.12 3.176.77.839 1.232 1.91 1.232 3.22 0 4.61-2.807 5.625-5.48 5.921.43.37.813 1.1.813 2.222v3.293c0 .32.218.694.825.576C20.565 21.796 24 17.303 24 12c0-6.63-5.373-12-12-12z"/>
            </svg>
            GitHub
        </a>
        <a href="LICENSE" target="_blank" class="flex items-center hover:text-gray-400 font-medium text-gray-400">
            <svg class="w-5 h-5 mr-1" fill="currentColor" viewBox="0 0 24 24">
                <path d="M6 2a2 2 0 0 0-2 2v16l4-4h12a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H6z"/>
            </svg>
            MIT License
        </a>
        <footer class="mt-8 pt-4 border-t border-gray-200 text-gray-600 text-xs text-center">
            <p>
            © 2025 btklab.
                <span data-lang-key="footerMadeWith">Made with</span> ❤
                <a href="https://plotly.com/javascript/" target="_blank" class="text-indigo-600 hover:text-indigo-800 font-semibold">Plotly.js</a>, 
                <a href="https://www.papaparse.com/" target="_blank" class="text-indigo-600 hover:text-indigo-800 font-semibold">PapaParse</a>, 
                <a href="https://sheetjs.com/" target="_blank" class="text-indigo-600 hover:text-indigo-800 font-semibold">SheetJS</a>, and
                <a href="https://tailwindcss.com/" target="_blank" class="text-indigo-600 hover:text-indigo-800 font-semibold">Tailwind CSS</a>.
            </p>
            <p>
                Penguins data is from
                <a href="https://github.com/allisonhorst/palmerpenguins" target="_blank" class="text-indigo-600 hover:text-indigo-800 font-semibold">the palmerpenguins R package</a>, 
                collected by Dr. Kristen Gorman & Palmer Station LTER. Artwork by
                <a href="https://github.com/allisonhorst" target="_blank" class="text-indigo-600 hover:text-indigo-800 font-semibold">@allison_horst</a>.
                 doi:10.5281/zenodo.3960218.
            </p>
        </footer>
    </div>

    <div class="main-content flex flex-col p-8 overflow-y-auto">
        
        <div id="chart-area" class="flex-grow bg-white p-6 rounded-xl shadow-lg mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-700" data-lang-key="chartDisplayTitle">📈 グラフ表示</h2>
                <button onclick="downloadChartAsImage()" id="download-image-btn" class="py-2 px-4 bg-green-500 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150 transform disabled:bg-gray-400" disabled>
                    <span data-lang-key="downloadImageButton">画像ダウンロード (PNG)</span>
                </button>
            </div>
            <div id="chart-container" class="w-full">
                <p class="text-gray-500 text-center pt-20" data-lang-key="chartContainerPlaceholder">ファイルをアップロードし、設定を行ってグラフを描画してください。</p>
            </div>
        </div>

        <div id="data-preview-section" class="mb-8 hidden bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-bold mb-4 text-gray-700" data-lang-key="dataPreviewTitle">📄 データプレビュー</h2>
            <div class="overflow-x-auto max-h-60">
                <table id="data-preview-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 sticky top-0"></thead>
                    <tbody class="bg-white divide-y divide-gray-200"></tbody>
                </table>
            </div>
        </div>

        <div id="summary-statistics-section" class="mb-8 hidden bg-white p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-700" data-lang-key="summaryStatsTitle">🔢 要約統計量 (数値列のみ)</h2>
                <button onclick="downloadSummaryStatistics()" id="download-summary-btn" class="py-2 px-4 bg-green-600 text-white text-sm font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150 transform disabled:bg-gray-400" disabled>
                   <span data-lang-key="downloadCsvButton">CSVダウンロード</span>
                </button>
            </div>
            <div id="summary-statistics-container" class="overflow-x-auto">
                <p class="text-gray-500 italic" data-lang-key="summaryStatsPlaceholder">データが読み込まれると、数値列の統計が表示されます。</p>
            </div>
        </div>
    </div>

    <script>
        // ===================================================================================
        // Security Utilities
        // ===================================================================================

        /**
         * Sanitizes a string by converting HTML special characters to their entity equivalents.
         * This helps prevent Cross-Site Scripting (XSS) attacks when rendering user-provided content.
         * @param {string} str - The input string to sanitize.
         * @returns {string} The sanitized string.
         */
        function sanitizeHTML(str) {
            if (typeof str !== 'string') return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return str.replace(/[&<>"']/g, (m) => map[m]);
        }

        // ===================================================================================
        // Internationalization (i18n)
        // ===================================================================================

        // Holds all UI strings for different languages.
        const translations = {
            en: {
                pageTitle: "📊 HakoHigeKun-R - Your Personal Offline Box-and-Whisker Plotter",
                appTitle: "📊 HakoHigeKun-R",
                fileUploadTitle: "📤 File Upload",
                fileUploadLabel: "Select or drag & drop a data file (*.xlsx, *.csv)",
                fileStatusSuccess: (rows, cols) => `✅ File loaded successfully<br>${rows} rows, ${cols} columns`,
                unsupportedFile: "Unsupported file format. Please upload a CSV, XLSX, or XLS file.",
                invalidData: (format) => `${format} file does not contain valid data.`,
                parseError: (format, msg) => `An error occurred while parsing the ${format} file: ${msg}`,
                readError: (format) => `An error occurred while reading the ${format} file.`,
                chartSettingsTitle: "⚙️ Chart Settings",
                chartTypeLabel: "Select Chart Type",
                chartConfigPlaceholder: "Select data and chart type to see settings.",
                chartTitleLabel: "Chart Title",
                chartTitlePlaceholder: "Untitled (auto-generated if blank)",
                drawChartButton: "🚀 Draw Chart",
                chartDisplayTitle: "📈 Chart Display",
                downloadImageButton: "Download Image (PNG)",
                chartContainerPlaceholder: "Upload a file and configure settings to draw a chart.",
                dataPreviewTitle: "📄 Data Preview",
                summaryStatsTitle: "🔢 Summary Statistics (Numeric columns only)",
                downloadCsvButton: "Download CSV",
                summaryStatsPlaceholder: "Statistics for numeric columns will be displayed when data is loaded.",
                noNumericData: "No columns with numeric data were found.",
                downloadStatsError: "No statistics data to download.",
                selectOptionDefault: "--- Select ---",
                indexOption: "--- Index (1, 2, 3...) ---",
                yAxisMultiSelectHint: "Hold Ctrl (Windows) / Cmd (Mac) to select multiple items.",
                errorDrawingChart: "Error drawing chart",
                errorCheckSettings: "An error occurred. Settings may be incorrect.",
                errorNotImplemented: "This chart type is not yet implemented.",
                errorMissingData: "Required data column not selected.",
                errorMissingX: "Bar/Line charts require an X-axis or index selection.",
                errorMissingY: "Y-axis data column not selected.",
                errorBoxData: "Box plot requires a data column.",
                //errorPairPlot: "Pair plot requires at least two numeric columns.",
                errorParetoCategory: "Category column is not selected.",
                errorXRData: "X-Rs Control Chart requires at least two numeric data points.",
                errorMRData: "Not enough data to calculate moving range.",
                downloadImageError: "An error occurred while downloading the chart image. Please check if the chart is displayed correctly.",
                refreshButton: "Refresh",
                refreshTitle: "Reload Application",
                sampleDataButton: "Load Sample Data",
                orText: "or",
                loadingSampleData: "Loading sample data...",
                errorLoadingSampleData: "Failed to load sample data. Please check the console for details.",
                chartTypes: {
                    box: "Box Plot",
                    histogram: "Histogram",
                    bar: "Bar Chart",
                    line: "Line Chart",
                    scatter: "Scatter Plot",
                    //pairplot: "Pair Plot",
                    pareto: "Pareto Chart",
                    xrs_control_chart: "X-Rs Control Chart"
                },
                configLabels: {
                    xAxisData: "Data Column (X-axis)",
                    yAxisData: "Data Column (Y-axis)",
                    yAxisDataMulti: "Data Columns (Y-axis) - Multi-select",
                    groupColumn: "Group Column (X-axis) (optional)",
                    groupColumns: "Group Columns (X-axis) (optional)",
                    multiGroupCheckbox: "Specify multiple columns",
                    colorGroup: "Color/Group Column (optional)",
                    nBins: "Number of Bins (N_bins)",
                    yAxisMulti: "Y-axis (Value) - Multi-select",
                    xAxisLabel: "X-axis (Label)",
                    yAxisValue: "Y-axis (Value)",
                    regressionLine: "Regression Line (optional)",
                    regression: { none: "None", linear: "Linear", poly: "Polynomial (2nd)" },
                    paretoCategory: "Category Column",
                    paretoCategories: "Category Columns",
                    paretoValue: "Value Column (optional)",
                    paretoValueOption: "(Count by rows)",
                    paretoTopN: "Show Top N Items",
                    paretoExcludeOther: 'Exclude "Other"',
                    xrsData: "Data Column"
                },
                statLabels: {
                    statistic: "Statistic",
                    count: "count", mean: "mean", std: "std", min: "min",
                    '25%': "25%", '50%': "50%", '75%': "75%", max: "max"
                }
            },
            ja: {
                pageTitle: "📊 箱ひげくん-R - Your Personal Offline Box-and-Whisker Plotter",
                appTitle: "📊 箱ひげくん-R",
                fileUploadTitle: "📤 ファイルアップロード",
                fileUploadLabel: "データファイルを選択、またはドラッグ＆ドロップ(*.xlsx, *.csv)",
                fileStatusSuccess: (rows, cols) => `✅ ファイル読み込み完了<br>${rows}行, ${cols}列`,
                unsupportedFile: "サポートされていないファイル形式です。CSV, XLSX, または XLSファイルをアップロードしてください。",
                invalidData: (format) => `${format}ファイルに有効なデータが含まれていません。`,
                parseError: (format, msg) => `${format}ファイルの解析中にエラーが発生しました: ${msg}`,
                readError: (format) => `${format}ファイルの読み込み中にエラーが発生しました。`,
                chartSettingsTitle: "⚙️ グラフの設定",
                chartTypeLabel: "グラフの種類を選択",
                chartConfigPlaceholder: "データを選択し、グラフの種類を選ぶと設定が表示されます。",
                chartTitleLabel: "グラフタイトル",
                chartTitlePlaceholder: "Untitled (空欄で自動設定)",
                drawChartButton: "🚀 グラフを描画",
                chartDisplayTitle: "📈 グラフ表示",
                downloadImageButton: "画像ダウンロード (PNG)",
                chartContainerPlaceholder: "ファイルをアップロードし、設定を行ってグラフを描画してください。",
                dataPreviewTitle: "📄 データプレビュー",
                summaryStatsTitle: "🔢 要約統計量 (数値列のみ)",
                downloadCsvButton: "CSVダウンロード",
                summaryStatsPlaceholder: "データが読み込まれると、数値列の統計が表示されます。",
                noNumericData: "数値データを含む列が見つませんでした。",
                downloadStatsError: "ダウンロードする統計データがありません。",
                selectOptionDefault: "--- 選択 ---",
                indexOption: "--- インデックス値 (1, 2, 3...) ---",
                yAxisMultiSelectHint: "Ctrlキー(Windows)/Cmdキー(Mac)を押しながらクリックで複数選択できます。",
                errorDrawingChart: "グラフ描画エラー",
                errorCheckSettings: "エラーが発生しました。設定が正しくない可能性があります。",
                errorNotImplemented: "このグラフタイプはまだ実装されていません。",
                errorMissingData: "描画に必要なデータ列が選択されていません。",
                errorMissingX: "棒グラフ、折れ線グラフにはX軸またはインデックスの選択が必要です。",
                errorMissingY: "Y軸にデータ列が選択されていません。",
                errorBoxData: "箱ひげ図にはデータ列が必要です。",
                //errorPairPlot: "行列散布図を描画するには、2つ以上の数値列が必要です。",
                errorParetoCategory: "カテゴリ列が選択されていません。",
                errorXRData: "X-Rs管理図を描画するには、2つ以上の数値データが必要です。",
                errorMRData: "移動範囲を計算できるデータがありません。",
                downloadImageError: "グラフ画像のダウンロード中にエラーが発生しました。グラフが正しく描画されているか確認してください。",
                refreshButton: "リフレッシュ",
                refreshTitle: "アプリを再読み込み",
                sampleDataButton: "サンプルデータを読み込む",
                orText: "または",
                loadingSampleData: "サンプルデータを読み込み中...",
                errorLoadingSampleData: "サンプルデータの読み込みに失敗しました。詳細はコンソールを確認してください。",
                chartTypes: {
                    box: '箱ひげ図',
                    histogram: 'ヒストグラム',
                    bar: '棒グラフ',
                    line: '折れ線グラフ',
                    scatter: '散布図',
                    //pairplot: '行列散布図', 
                    pareto: 'パレート図',
                    xrs_control_chart: 'X-Rs管理図',
                },
                configLabels: {
                    xAxisData: "データ列 (X軸)",
                    yAxisData: "データ列 (Y軸)",
                    yAxisDataMulti: "データ列 (Y軸) - 複数選択可能",
                    groupColumn: "グループ列 (X軸) (オプション)",
                    groupColumns: "グループ列 (X軸) (オプション)",
                    multiGroupCheckbox: "複数列を指定",
                    colorGroup: "グループ列 (色分け) (オプション)",
                    nBins: "ビンの数 (N_bins)",
                    yAxisMulti: "Y軸 (値) - 複数選択可能",
                    xAxisLabel: "X軸 (ラベル)",
                    yAxisValue: "Y軸 (値)",
                    regressionLine: "回帰線 (オプション)",
                    regression: { none: "なし", linear: "線形", poly: "多項式 (2次)" },
                    paretoCategory: "カテゴリ列",
                    paretoCategories: "カテゴリ列",
                    paretoValue: "集計値列 (オプション)",
                    paretoValueOption: "(行数で集計)",
                    paretoTopN: "上位N件表示",
                    paretoExcludeOther: "「その他」を除外する",
                    xrsData: "データ列"
                },
                statLabels: {
                    statistic: "統計量",
                    count: "count", mean: "mean", std: "std", min: "min",
                    '25%': "25%", '50%': "50%", '75%': "75%", max: "max"
                }
            }
        };
        let currentLang = 'ja';
        let groupingActive = false;

        /**
         * Sets the application language and updates the UI.
         * @param {string} lang - The language to set ('en' or 'ja').
         */
        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);

            // Re-generate CHART_TYPES based on the selected language
            const t = translations[lang];
            Object.assign(CHART_TYPES, t.chartTypes);
        
            updateUI(lang);
        }
        /**
         * Updates all text elements in the UI to the selected language.
         * @param {string} lang - The language to display ('en' or 'ja').
         */
        function updateUI(lang) {
            document.documentElement.lang = lang;
            const t = translations[lang];

            // Update static text content using data-lang-key attributes
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (t[key]) {
                    el.textContent = t[key];
                }
            });

            // Update placeholder text using data-lang-key-placeholder attributes
            document.querySelectorAll('[data-lang-key-placeholder]').forEach(el => {
                const key = el.getAttribute('data-lang-key-placeholder');
                if (t[key]) {
                    el.placeholder = t[key];
                }
            });
            
            // Update title text using data-lang-key-title attributes
            document.querySelectorAll('[data-lang-key-title]').forEach(el => {
                const key = el.getAttribute('data-lang-key-title');
                if (t[key]) {
                    el.title = t[key];
                }
            });

            // Update the active state of the language switcher buttons
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.getAttribute('data-lang') === lang);
            });
            
            // Re-render dynamic UI components if data is already loaded
            if (columns.length > 0) {
                populateChartTypeSelect();
                renderChartConfigUI();
                renderSummaryStatistics(); // Re-render with translated headers
            }
        }
        
        // ===================================================================================
        // Global Variables & Initial Settings
        // ===================================================================================

        let rawData = []; // Array of objects from the parsed file
        let columns = []; // Array of column header strings
        const chartContainer = document.getElementById('chart-container');
        const fileInput = document.getElementById('file-input');
        const chartTypeSelect = document.getElementById('chart-type-select');
        const chartConfigArea = document.getElementById('chart-config-area');
        const drawChartButton = document.getElementById('draw-chart-button');
        const downloadImageBtn = document.getElementById('download-image-btn'); 
        let calculatedSummaryStats = {}; // Cache for summary statistics data

        // Chart type definitions (internal keys to translated names)
        const CHART_TYPES = {
            'box': '箱ひげ図',
            'histogram': 'ヒストグラム',
            'bar': '棒グラフ',
            'line': '折れ線グラフ',
            'scatter': '散布図',
            //'pairplot': '行列散布図', 
            'pareto': 'パレート図',
            'xrs_control_chart': 'X-Rs管理図',
        };
        
        // Coefficients for X-Rs Control Chart (only for subgroup size n=2)
        const CONTROL_CHART_COEFFICIENTS = { 2: { A2: 1.880, D4: 3.267, d2: 1.128, E2: 2.660 } };

        // ===================================================================================
        // Sample Data (Embedded for Offline Use)
        // ===================================================================================
        const sampleCsvData = `species,island,bill_length_mm,bill_depth_mm,flipper_length_mm,body_mass_g,sex,year
Adelie,Torgersen,39.1,18.7,181,3750,male,2007
Adelie,Torgersen,39.5,17.4,186,3800,female,2007
Adelie,Torgersen,40.3,18,195,3250,female,2007
Adelie,Torgersen,NA,NA,NA,NA,NA,2007
Adelie,Torgersen,36.7,19.3,193,3450,female,2007
Adelie,Torgersen,39.3,20.6,190,3650,male,2007
Adelie,Torgersen,38.9,17.8,181,3625,female,2007
Adelie,Torgersen,39.2,19.6,195,4675,male,2007
Adelie,Torgersen,34.1,18.1,193,3475,NA,2007
Adelie,Torgersen,42,20.2,190,4250,NA,2007
Adelie,Torgersen,37.8,17.1,186,3300,NA,2007
Adelie,Torgersen,37.8,17.3,180,3700,NA,2007
Adelie,Torgersen,41.1,17.6,182,3200,female,2007
Adelie,Torgersen,38.6,21.2,191,3800,male,2007
Adelie,Torgersen,34.6,21.1,198,4400,male,2007
Adelie,Torgersen,36.6,17.8,185,3700,female,2007
Adelie,Torgersen,38.7,19,195,3450,female,2007
Adelie,Torgersen,42.5,20.7,197,4500,male,2007
Adelie,Torgersen,34.4,18.4,184,3325,female,2007
Adelie,Torgersen,46,21.5,194,4200,male,2007
Adelie,Biscoe,37.8,18.3,174,3400,female,2007
Adelie,Biscoe,37.7,18.7,180,3600,male,2007
Adelie,Biscoe,35.9,19.2,189,3800,female,2007
Adelie,Biscoe,38.2,18.1,185,3950,male,2007
Adelie,Biscoe,38.8,17.2,180,3800,male,2007
Adelie,Biscoe,35.3,18.9,187,3800,female,2007
Adelie,Biscoe,40.6,18.6,183,3550,male,2007
Adelie,Biscoe,40.5,17.9,187,3200,female,2007
Adelie,Biscoe,37.9,18.6,172,3150,female,2007
Adelie,Biscoe,40.5,18.9,180,3950,male,2007
Adelie,Dream,39.5,16.7,178,3250,female,2007
Adelie,Dream,37.2,18.1,178,3900,male,2007
Adelie,Dream,39.5,17.8,188,3300,female,2007
Adelie,Dream,40.3,18.5,196,3950,male,2007
Adelie,Dream,36.5,18,182,3150,female,2007
Adelie,Dream,40.8,18.9,197,4450,male,2007
Adelie,Dream,36,17.9,190,3450,female,2007
Adelie,Dream,42.2,18.5,180,3550,female,2007
Adelie,Dream,37.6,19.1,194,3750,male,2007
Adelie,Dream,39.8,19.1,184,4650,male,2007
Adelie,Dream,36.5,16.6,181,2850,female,2007
Adelie,Dream,40.7,17,190,3725,male,2007
Adelie,Dream,37.3,17.8,191,3350,male,2007
Adelie,Dream,39,17.5,186,3550,female,2007
Adelie,Dream,40.2,17,176,3450,female,2007
Adelie,Dream,37.7,19.8,198,3500,male,2007
Adelie,Dream,36,17.8,185,3400,female,2007
Adelie,Dream,35.7,16.9,185,3150,female,2007
Adelie,Torgersen,40.2,17.1,193,3400,female,2008
Adelie,Torgersen,41.4,18.5,202,3875,male,2008
Adelie,Torgersen,35.2,17.4,192,3450,female,2008
Adelie,Torgersen,40.6,19,194,3800,male,2008
Adelie,Torgersen,38.8,17.6,191,3275,female,2008
Adelie,Torgersen,41.5,18.5,190,4250,male,2008
Adelie,Torgersen,35.5,17.5,190,3700,female,2008
Adelie,Torgersen,42.4,17.3,181,3600,female,2008
Adelie,Torgersen,44.1,19.7,196,4400,male,2008
Adelie,Torgersen,33.5,19,190,3600,female,2008
Adelie,Torgersen,41,18.2,190,3425,male,2008
Adelie,Torgersen,37.5,18.9,179,2975,NA,2008
Adelie,Torgersen,39.7,18.4,190,3900,male,2008
Adelie,Torgersen,43.2,18.5,192,4100,male,2008
Adelie,Biscoe,38.1,17.6,187,3425,female,2008
Adelie,Biscoe,38,17.9,190,3425,female,2008
Adelie,Biscoe,43.2,19,197,4775,male,2008
Adelie,Biscoe,35,17.9,190,3450,female,2008
Adelie,Biscoe,41,19.5,200,4300,male,2008
Adelie,Biscoe,35.5,17.8,190,3350,female,2008
Adelie,Biscoe,41.8,18.4,195,4100,male,2008
Adelie,Biscoe,36.4,17.1,184,2850,female,2008
Adelie,Biscoe,39.2,21.1,196,4150,male,2008
Adelie,Biscoe,38.8,17.6,191,3275,female,2008
Adelie,Biscoe,42.9,17.6,196,4700,male,2008
Adelie,Biscoe,36.4,18.4,184,2900,female,2008
Adelie,Biscoe,42.1,19.1,195,4000,male,2008
Adelie,Biscoe,34.5,18.1,187,2900,female,2008
Adelie,Biscoe,45.8,18.9,197,4150,male,2008
Adelie,Biscoe,36.7,18.8,187,3800,female,2008
Adelie,Biscoe,36,18.5,186,3450,female,2008
Adelie,Biscoe,42.3,21.2,191,4150,male,2008
Adelie,Biscoe,39.6,18.1,186,4450,male,2008
Adelie,Dream,36.2,16.1,187,3550,female,2008
Adelie,Dream,42.1,18.3,195,4050,male,2008
Adelie,Dream,34.8,17.7,198,3350,female,2008
Adelie,Dream,40.5,18.1,196,3950,male,2008
Adelie,Dream,37.9,18.1,193,3750,male,2008
Adelie,Dream,35,17.8,188,3600,female,2008
Adelie,Dream,41.3,20.3,194,3550,male,2008
Adelie,Dream,36.3,19.5,190,3800,male,2008
Adelie,Dream,36.9,18.6,189,3500,female,2008
Adelie,Dream,38.3,19.2,189,3950,male,2008
Adelie,Dream,38.9,18.8,190,3600,female,2008
Adelie,Dream,41.3,21.1,195,4400,male,2008
Adelie,Dream,36.3,17.1,186,3475,female,2008
Adelie,Dream,42.6,19.2,196,4550,male,2008
Adelie,Dream,38.5,17,187,3550,female,2008
Adelie,Dream,42.5,17.3,187,3550,female,2008
Adelie,Torgersen,38.6,17,188,2900,female,2009
Adelie,Torgersen,38.1,18.6,190,3700,female,2009
Adelie,Torgersen,40.3,17,187,3475,female,2009
Adelie,Torgersen,33.1,16.1,178,2900,female,2009
Adelie,Torgersen,43.2,16.6,187,2900,female,2009
Adelie,Biscoe,39.7,17.7,193,3200,female,2009
Adelie,Biscoe,38.1,18.2,198,3700,male,2009
Adelie,Biscoe,39.6,17.7,186,3500,female,2009
Adelie,Biscoe,40.1,18.9,188,4300,male,2009
Adelie,Biscoe,35.7,18,202,3550,female,2009
Adelie,Biscoe,42,16.5,185,3400,female,2009
Adelie,Biscoe,39.7,18.9,184,3900,male,2009
Adelie,Biscoe,39.8,18.8,190,3900,male,2009
Adelie,Biscoe,39.6,18.8,191,3775,male,2009
Adelie,Dream,35.9,16.6,190,3050,female,2009
Adelie,Dream,39.3,16.7,190,3800,male,2009
Adelie,Dream,41.2,18.1,192,3500,female,2009
Adelie,Dream,38.7,18.7,185,3450,female,2009
Adelie,Dream,42.5,18.3,196,4050,male,2009
Adelie,Dream,39,18.7,185,3650,male,2009
Adelie,Dream,35.3,17.6,190,3450,female,2009
Adelie,Dream,41.4,18.6,191,3700,female,2009
Adelie,Dream,42.3,18.3,191,4250,male,2009
Adelie,Dream,39.6,17.2,186,3800,female,2009
Adelie,Dream,40.9,16.8,191,3700,female,2009
Adelie,Dream,40.9,18.9,184,3900,male,2009
Adelie,Torgersen,41.7,18.7,190,3250,male,2007
Adelie,Torgersen,35.6,17.5,191,3175,female,2007
Adelie,Torgersen,41.1,18.1,205,4300,male,2007
Adelie,Torgersen,36.4,17,195,2950,female,2007
Adelie,Torgersen,39.2,21.1,196,4150,male,2007
Adelie,Torgersen,38.8,17.6,191,3275,female,2007
Adelie,Torgersen,42.2,19.5,197,4275,male,2007
Adelie,Torgersen,38.1,17,198,3175,female,2007
Adelie,Torgersen,41.1,18.6,189,3325,male,2007
Adelie,Torgersen,37.6,17.9,181,3175,female,2007
Adelie,Torgersen,37.9,18.6,193,2925,female,2007
Adelie,Torgersen,40.8,18.4,195,3900,male,2007
Adelie,Biscoe,40.9,16.6,187,3200,female,2008
Adelie,Biscoe,38.6,17.2,188,3800,female,2008
Adelie,Biscoe,37.3,16.5,189,3250,female,2008
Adelie,Biscoe,42.7,18.3,196,4075,male,2008
Adelie,Biscoe,38.1,16.5,198,3825,female,2008
Adelie,Biscoe,42.8,18.5,195,4250,male,2008
Adelie,Biscoe,40.9,19.1,196,4550,male,2008
Adelie,Biscoe,36.2,17.2,187,3150,female,2008
Adelie,Biscoe,42,18.1,195,4350,male,2008
Adelie,Biscoe,39.6,17.8,195,3650,female,2008
Adelie,Biscoe,40.1,19.6,196,4700,male,2008
Adelie,Dream,33.8,17.7,179,3400,female,2008
Adelie,Dream,41.6,18,192,3950,male,2008
Adelie,Dream,35.7,17,189,3350,female,2008
Adelie,Dream,41.1,19.1,188,4100,male,2008
Adelie,Dream,37.9,18.6,172,3150,female,2008
Adelie,Dream,39.1,18.8,190,4200,male,2008
Adelie,Dream,37.2,19.4,184,3900,male,2008
Adelie,Dream,39.7,17.9,193,4250,male,2008
Adelie,Dream,40.6,17.2,187,3475,male,2008
Adelie,Torgersen,37.9,18.1,193,3750,male,2009
Adelie,Torgersen,40.2,17.8,196,3975,male,2009
Adelie,Torgersen,36.8,18.5,193,3500,female,2009
Adelie,Torgersen,38.5,17.9,190,3325,female,2009
Adelie,Torgersen,43.1,19.8,198,4500,male,2009
Adelie,Torgersen,41.3,18.5,195,3500,female,2009
Adelie,Torgersen,36.7,18.5,185,3500,female,2009
Adelie,Biscoe,44,17.4,198,4300,male,2009
Adelie,Biscoe,37.7,16.5,189,3250,female,2009
Adelie,Biscoe,40.8,18.2,195,3925,male,2009
Adelie,Biscoe,39.1,17.1,191,4000,male,2009
Adelie,Biscoe,42.6,18.4,193,3900,male,2009
Adelie,Biscoe,40.2,18.3,180,3975,male,2009
Adelie,Biscoe,37.6,18.8,192,3750,female,2009
Adelie,Biscoe,38.1,17.6,187,3425,female,2009
Adelie,Biscoe,41.1,19,182,3425,male,2009
Adelie,Dream,37.5,18.5,199,3550,male,2009
Adelie,Dream,38.1,18.6,190,3700,female,2009
Adelie,Dream,39.7,18.3,193,3650,male,2009
Adelie,Dream,39.8,18.5,198,3900,male,2009
Adelie,Dream,36.6,18.4,184,3475,female,2009
Adelie,Dream,36.2,17.8,185,3700,female,2009
Adelie,Dream,42.8,17.5,195,4250,male,2009
Adelie,Dream,40.9,17.2,187,3525,female,2009
Adelie,Dream,36.1,18.6,189,3350,female,2009
Adelie,Dream,42.3,19.3,191,4050,male,2009
Adelie,Dream,38.2,17.6,187,3450,female,2009
Adelie,Dream,40.3,17.5,187,3500,female,2009
Adelie,Dream,39.7,18.8,193,4250,male,2009
Adelie,Dream,43.3,19.9,198,4800,male,2009
Adelie,Dream,36.8,18.4,195,3550,female,2009
Adelie,Dream,35.5,18.8,193,4100,male,2009
Gentoo,Biscoe,46.1,13.2,211,4500,female,2007
Gentoo,Biscoe,50,16.3,230,5700,male,2007
Gentoo,Biscoe,48.7,14.1,210,4450,female,2007
Gentoo,Biscoe,50,15.2,218,5700,male,2007
Gentoo,Biscoe,47.6,14.5,215,5400,male,2007
Gentoo,Biscoe,46.5,13.5,210,4550,female,2007
Gentoo,Biscoe,45.4,14.6,211,4800,female,2007
Gentoo,Biscoe,46.7,15.3,219,5200,male,2007
Gentoo,Biscoe,43.3,13.4,209,4400,female,2007
Gentoo,Biscoe,46.8,14.3,215,4850,NA,2007
Gentoo,Biscoe,50.4,15.3,224,5550,male,2007
Gentoo,Biscoe,45.7,13.9,214,4400,female,2007
Gentoo,Biscoe,49.2,15.2,221,6300,male,2007
Gentoo,Biscoe,46.5,14.5,213,4400,female,2007
Gentoo,Biscoe,45.5,14.5,212,4750,female,2007
Gentoo,Biscoe,48.4,14.6,213,5850,male,2007
Gentoo,Biscoe,51.1,16.5,230,5950,male,2007
Gentoo,Biscoe,48.5,15,219,4850,female,2007
Gentoo,Biscoe,42.9,13.1,215,5000,female,2007
Gentoo,Biscoe,50.7,15,223,5550,male,2007
Gentoo,Biscoe,45.2,13.8,215,5300,female,2007
Gentoo,Biscoe,49.1,14.5,212,4625,female,2007
Gentoo,Biscoe,47,15.5,215,5200,male,2007
Gentoo,Biscoe,49.1,14.8,220,5150,female,2007
Gentoo,Biscoe,47.3,13.8,216,4725,NA,2007
Gentoo,Biscoe,46.6,14.2,210,4850,female,2007
Gentoo,Biscoe,48.5,14.1,220,5300,male,2007
Gentoo,Biscoe,47.5,14.5,215,4875,female,2007
Gentoo,Biscoe,47.4,14.6,212,4750,female,2007
Gentoo,Biscoe,46.5,14.4,217,4900,female,2007
Gentoo,Biscoe,46.1,15.1,215,5100,male,2007
Gentoo,Biscoe,50.2,14.3,218,5700,male,2007
Gentoo,Biscoe,45.1,14.5,215,5000,female,2007
Gentoo,Biscoe,46.2,14.1,217,4375,female,2007
Gentoo,Biscoe,48.8,16.2,222,6000,male,2007
Gentoo,Biscoe,45.1,14.5,207,5050,female,2007
Gentoo,Biscoe,50.1,15,225,5000,male,2007
Gentoo,Biscoe,46.5,14.8,217,5200,female,2007
Gentoo,Biscoe,48.2,14.3,210,4600,female,2007
Gentoo,Biscoe,50,15.3,220,5550,male,2007
Gentoo,Biscoe,47.3,15.3,222,5250,male,2007
Gentoo,Biscoe,42,13.5,210,4150,female,2007
Gentoo,Biscoe,49.5,16.2,225,5650,male,2007
Gentoo,Biscoe,44.5,14.3,216,4100,NA,2007
Gentoo,Biscoe,47.8,15,215,5650,male,2007
Gentoo,Biscoe,43.8,13.9,208,4300,female,2007
Gentoo,Biscoe,45.5,13.7,214,4650,female,2007
Gentoo,Biscoe,50.8,17.2,228,5800,male,2008
Gentoo,Biscoe,49.4,15.8,216,4925,male,2008
Gentoo,Biscoe,46.9,14.6,222,4875,female,2008
Gentoo,Biscoe,48.4,16.3,220,5400,male,2008
Gentoo,Biscoe,42.6,13.7,213,4150,female,2008
Gentoo,Biscoe,52.1,17,230,5550,male,2008
Gentoo,Biscoe,48.1,15.1,209,5500,male,2008
Gentoo,Biscoe,45,15.4,220,5050,female,2008
Gentoo,Biscoe,50.5,15.9,225,5400,male,2008
Gentoo,Biscoe,44.9,13.3,213,5100,female,2008
Gentoo,Biscoe,45.2,14.8,212,5200,female,2008
Gentoo,Biscoe,49.7,15.8,228,5700,male,2008
Gentoo,Biscoe,49.5,15.8,224,5350,male,2008
Gentoo,Biscoe,45.3,14.5,210,5300,female,2008
Gentoo,Biscoe,49.6,16,225,5700,male,2008
Gentoo,Biscoe,45.1,14.4,210,4400,female,2008
Gentoo,Biscoe,50.1,15.9,225,5175,male,2008
Gentoo,Biscoe,50.5,15.2,216,5000,female,2008
Gentoo,Biscoe,47.5,15,218,4950,female,2008
Gentoo,Biscoe,51.5,16.3,230,5500,male,2008
Gentoo,Biscoe,45.7,14.6,210,4725,female,2008
Gentoo,Biscoe,49.8,15.9,229,5950,male,2008
Gentoo,Biscoe,46.3,15.8,215,5050,male,2008
Gentoo,Biscoe,42.7,13.7,208,4575,female,2008
Gentoo,Biscoe,49.2,14.9,212,5075,male,2008
Gentoo,Biscoe,47.7,15,216,4900,female,2008
Gentoo,Biscoe,46.4,15,216,4700,female,2008
Gentoo,Biscoe,50.4,15.7,222,5750,male,2008
Gentoo,Biscoe,51.3,14.2,218,5125,male,2008
Gentoo,Biscoe,47.5,15.8,215,5200,male,2008
Gentoo,Biscoe,45.5,15,220,5000,female,2008
Gentoo,Biscoe,43.2,14.5,208,4450,female,2008
Gentoo,Biscoe,48.7,15.7,208,5350,male,2008
Gentoo,Biscoe,45.1,14.8,215,5300,female,2008
Gentoo,Biscoe,50.2,15.1,228,5500,male,2008
Gentoo,Biscoe,45.6,14.2,211,4650,female,2008
Gentoo,Biscoe,50.9,15.7,226,5200,male,2008
Gentoo,Biscoe,45.5,14.2,210,4400,female,2008
Gentoo,Biscoe,48.4,14.4,203,4625,female,2008
Gentoo,Biscoe,52.8,15.8,229,5950,male,2008
Gentoo,Biscoe,49.1,15,228,5500,male,2008
Gentoo,Biscoe,48.4,15.4,220,5100,male,2008
Gentoo,Biscoe,42.5,14.9,200,4175,female,2008
Gentoo,Biscoe,45,15.8,215,5100,female,2008
Gentoo,Biscoe,46.4,15.6,221,5000,male,2008
Gentoo,Biscoe,48.2,15.6,221,5100,male,2008
Gentoo,Biscoe,46.7,15.3,219,5200,male,2009
Gentoo,Biscoe,43.6,13.9,217,4900,female,2009
Gentoo,Biscoe,45.8,14.6,210,4200,female,2009
Gentoo,Biscoe,50.9,16.5,230,5700,male,2009
Gentoo,Biscoe,45.8,14.2,219,4700,female,2009
Gentoo,Biscoe,49.8,16.8,230,5700,male,2009
Gentoo,Biscoe,46.2,14.4,214,4650,NA,2009
Gentoo,Biscoe,45.5,13.9,210,4200,female,2009
Gentoo,Biscoe,50.9,17.5,223,5550,male,2009
Gentoo,Biscoe,48.1,16.4,209,5150,female,2009
Gentoo,Biscoe,47.4,15,225,5400,male,2009
Gentoo,Biscoe,45.6,15.3,220,5300,female,2009
Gentoo,Biscoe,51.9,17,230,5900,male,2009
Gentoo,Biscoe,46.8,15.4,215,5150,male,2009
Gentoo,Biscoe,45.8,15.9,215,5300,male,2009
Gentoo,Biscoe,45.3,13.7,210,4300,female,2009
Gentoo,Biscoe,46.1,14.7,216,4700,female,2009
Gentoo,Biscoe,51.3,16,230,5800,male,2009
Gentoo,Biscoe,47.5,14.1,212,4500,female,2009
Gentoo,Biscoe,54.3,15.7,231,5650,male,2009
Gentoo,Biscoe,48.8,15.2,222,5350,male,2009
Gentoo,Biscoe,47.2,15.5,215,4975,female,2009
Gentoo,Biscoe,49.1,15.2,218,5100,male,2009
Gentoo,Biscoe,48.5,15.1,220,5800,male,2009
Gentoo,Biscoe,43.2,15,215,4950,female,2009
Gentoo,Biscoe,50.7,15.9,228,5200,male,2009
Gentoo,Biscoe,47.7,16,215,4800,male,2009
Gentoo,Biscoe,46.4,15.8,216,5200,male,2009
Gentoo,Biscoe,45.9,14.6,221,4500,female,2009
Gentoo,Biscoe,48.4,14,215,4850,female,2009
Chinstrap,Dream,46.5,17.9,192,3500,female,2007
Chinstrap,Dream,50,19.5,196,3900,male,2007
Chinstrap,Dream,51.3,19.2,193,3650,male,2007
Chinstrap,Dream,45.4,18.7,188,3525,female,2007
Chinstrap,Dream,52.7,19.8,197,3725,male,2007
Chinstrap,Dream,45.2,17.8,198,3950,female,2007
Chinstrap,Dream,49.6,18.2,193,3775,male,2007
Chinstrap,Dream,49.1,19.4,200,4400,male,2007
Chinstrap,Dream,48.2,18.1,192,3950,male,2007
Chinstrap,Dream,51,18.8,203,4100,male,2007
Chinstrap,Dream,48.5,17.6,191,3400,female,2007
Chinstrap,Dream,46.4,17.8,191,3700,female,2007
Chinstrap,Dream,50.5,19.6,201,4050,male,2007
Chinstrap,Dream,50.3,20,197,3300,male,2007
Chinstrap,Dream,58,17.8,181,3700,female,2007
Chinstrap,Dream,46.1,18.2,178,3250,female,2007
Chinstrap,Dream,51.3,18.2,197,3950,male,2007
Chinstrap,Dream,47.5,16.8,199,3900,female,2007
Chinstrap,Dream,51.7,20.3,194,3775,male,2007
Chinstrap,Dream,50.8,19,210,4100,male,2007
Chinstrap,Dream,47,17.3,185,3700,female,2007
Chinstrap,Dream,52,18.1,201,4050,male,2007
Chinstrap,Dream,45.9,17.1,190,3575,female,2007
Chinstrap,Dream,49.8,17.3,198,3675,female,2008
Chinstrap,Dream,48.1,16.5,199,3525,female,2008
Chinstrap,Dream,51.4,19,201,3950,male,2008
Chinstrap,Dream,45.7,17.3,193,3600,female,2008
Chinstrap,Dream,50.7,18.3,203,4000,male,2008
Chinstrap,Dream,52.2,18.8,197,3450,male,2008
Chinstrap,Dream,45.2,16.6,191,3250,female,2008
Chinstrap,Dream,49.3,19.9,203,4050,male,2008
Chinstrap,Dream,51.3,19.9,207,4550,male,2008
Chinstrap,Dream,47.6,18.3,195,3850,female,2008
Chinstrap,Dream,52,20.7,210,4800,male,2008
Chinstrap,Dream,46.9,16.6,192,2700,female,2008
Chinstrap,Dream,53.5,19.9,205,4500,male,2008
Chinstrap,Dream,49,19.5,210,3950,male,2008
Chinstrap,Dream,46.2,17.5,187,3650,female,2008
Chinstrap,Dream,50.9,19.1,196,3550,male,2008
Chinstrap,Dream,45.5,17,196,3500,female,2008
Chinstrap,Dream,50.9,17.9,196,3675,female,2009
Chinstrap,Dream,50.8,18.5,201,4450,male,2009
Chinstrap,Dream,50.1,17.9,190,3400,female,2009
Chinstrap,Dream,49,19.6,212,4300,male,2009
Chinstrap,Dream,51.5,18.9,207,4500,male,2009
Chinstrap,Dream,49.8,18.8,203,3800,female,2009
Chinstrap,Dream,49.5,19,200,3800,male,2009
Chinstrap,Dream,46.5,18.5,195,3600,female,2009
Chinstrap,Dream,50.5,18.4,200,3400,female,2009
Chinstrap,Dream,50.3,19.5,193,3775,male,2009
Chinstrap,Dream,48.8,17.2,208,4150,female,2009
Chinstrap,Dream,52.5,18.9,200,4200,male,2009
Chinstrap,Dream,47.4,16.8,199,3700,female,2009
Chinstrap,Dream,51.5,19.2,201,3550,male,2009
Chinstrap,Dream,48.4,17.3,199,3500,female,2009
Chinstrap,Dream,52.8,20,205,4550,male,2009
Chinstrap,Dream,48.5,17.5,191,3400,female,2009
Chinstrap,Dream,52.1,18.6,190,3825,male,2009
Chinstrap,Dream,49,17.2,187,3550,female,2009
Chinstrap,Dream,51,19,195,4400,male,2009
Chinstrap,Dream,48.5,17.7,200,3500,female,2009
Chinstrap,Dream,50.2,18.8,202,3800,male,2009
`;

        /**
         * Populates the chart type dropdown with translated options.
         */
        function populateChartTypeSelect() {
            chartTypeSelect.innerHTML = '';
            const chartTypeTranslations = translations[currentLang].chartTypes;
            Object.keys(CHART_TYPES).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = chartTypeTranslations[key] || CHART_TYPES[key];
                chartTypeSelect.appendChild(option);
            });
        }
        
        // ===================================================================================
        // Initialization
        // ===================================================================================

        /**
         * Initializes the application.
         */
        function initializeApp() {
            // Set language based on localStorage or browser preference
            const savedLang = localStorage.getItem('language');
            const browserLang = navigator.language.startsWith('ja') ? 'ja' : 'en';
            setLanguage(savedLang || browserLang);
            
            // Populate the chart type dropdown
            populateChartTypeSelect();

            // Set up event listeners
            fileInput.addEventListener('change', handleFileSelect);
            chartTypeSelect.addEventListener('change', renderChartConfigUI);
        }

        // ===================================================================================
        // File Handling
        // ===================================================================================
        
        /**
         * Loads and parses the embedded palmerpenguins sample CSV data.
         */
        function loadSampleData() {
            const statusElement = document.getElementById('file-status');
            const t = translations[currentLang];

            statusElement.textContent = t.loadingSampleData;
            statusElement.classList.remove('hidden', 'text-red-600');
            statusElement.classList.add('text-blue-600');

            // Clear the file input value, so it doesn't look like a file is still selected
            fileInput.value = '';

            // Use PapaParse to process the embedded CSV string
            Papa.parse(sampleCsvData, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data.length === 0) {
                        alert(t.invalidData('CSV'));
                        return;
                    }
                    const headers = results.meta.fields.filter(f => f != null);
                    processParsedData(results.data, headers);
                },
                error: function(error) {
                    console.error('Error parsing sample data:', error);
                    statusElement.innerHTML = `${t.errorLoadingSampleData}<br><span class="text-xs">${sanitizeHTML(error.message)}</span>`;
                    statusElement.classList.remove('hidden', 'text-blue-600');
                    statusElement.classList.add('text-red-600');
                    alert(t.parseError('CSV', error.message));
                }
            });
        }

        /**
         * Handles the file selection event and routes to the appropriate parser.
         * @param {Event} event - The file input change event.
         */
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileName = file.name.toLowerCase();
            const t = translations[currentLang];

            if (fileName.endsWith('.csv')) {
                parseCSV(file);
            } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                parseExcel(file);
            } else {
                alert(t.unsupportedFile);
                document.getElementById('file-status').classList.add('hidden');
                document.getElementById('chart-settings').classList.add('hidden');
            }
            // Disable download button when a new file is loaded
            downloadImageBtn.disabled = true;
        }

        /**
         * Parses a CSV file using PapaParse.
         * @param {File} file - The CSV file to parse.
         */
        function parseCSV(file) {
            Papa.parse(file, {
                header: true, 
                dynamicTyping: true, 
                skipEmptyLines: true, 
                //encoding: 'Shift_JIS', 
                encoding: 'UTF-8', 
                complete: function(results) {
                    const t = translations[currentLang];
                    if (results.data.length === 0) {
                        alert(t.invalidData('CSV'));
                        return;
                    }
                    // Filter out any null headers that PapaParse might create
                    const headers = results.meta.fields.filter(f => f != null);
                    processParsedData(results.data, headers);
                },
                error: function(error) {
                    alert(translations[currentLang].parseError('CSV', error.message));
                }
            });
        }
        
        /**
         * Parses an Excel file (.xlsx, .xls) using SheetJS.
         * @param {File} file - The Excel file to parse.
         */
        function parseExcel(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const t = translations[currentLang];
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { 
                        type: 'array', 
                        cellDates: true, 
                        raw: false 
                    });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    let jsonDataArray = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1, 
                        raw: false 
                    });
                    
                    if (jsonDataArray.length < 2) {
                         alert(t.invalidData('Excel'));
                         return;
                    }

                    // Extract headers and data rows
                    const headers = jsonDataArray[0].map(h => String(h).trim() || `Column_${Math.random().toString(36).substring(7)}`);
                    const dataRows = jsonDataArray.slice(1);
                    const results = [];
                    
                    // Process each row to create a consistent object structure
                    dataRows.forEach(rowData => {
                        const row = {};
                        let hasValidData = false;
                        headers.forEach((header, j) => {
                            let value = rowData[j];
                            // Clean and type-cast values
                            if (value === undefined || value === null || (typeof value === 'string' && value.trim() === '')) {
                                value = null;
                            } else if (typeof value === 'string') {
                                const num = Number(value);
                                value = isNaN(num) ? value : num;
                            } else if (value instanceof Date) {
                                value = value.toISOString();
                            }
                            row[header] = value;
                            if (value !== null) hasValidData = true;
                        });
                        if (hasValidData) results.push(row);
                    });
                    
                    if (results.length === 0) {
                         alert(t.invalidData('Excel'));
                         return;
                    }
                    processParsedData(results, headers);
                } catch (error) {
                    alert(t.parseError('Excel', error.message));
                }
            };
            reader.onerror = () => alert(translations[currentLang].readError('Excel'));
            reader.readAsArrayBuffer(file);
        }
        
        /**
         * Common data processing function after a file is parsed successfully.
         * @param {Array<Object>} data - The parsed data.
         * @param {Array<string>} fields - The column headers.
         */
        function processParsedData(data, fields) {
            rawData = data;
            columns = fields;

            // Update UI to show file status and reveal settings
            const statusElement = document.getElementById('file-status');
            statusElement.innerHTML = translations[currentLang]
                .fileStatusSuccess(rawData.length, columns.length);
            statusElement.classList.remove('hidden');

            document.getElementById('chart-settings').classList.remove('hidden');
            document.getElementById('data-preview-section').classList.remove('hidden');
            document.getElementById('summary-statistics-section').classList.remove('hidden'); 
            drawChartButton.disabled = false;
            
            // Render UI components with the new data
            renderDataPreview();
            renderSummaryStatistics(); 
            renderChartConfigUI(); 
            
            // (Optional) Auto-draw the graph with the first numeric column set
            const initialChartType = chartTypeSelect.value;
            if (initialChartType === 'box' && findFirstNumericColumn(data, fields)) {
                drawChart();
            }
        }
        
        /**
         * Helper function to find the name of the first column containing numerical data.
         * @param {Array<Object>} data - The parsed data.
         * @param {Array<string>} columns - The column headers.
         * @returns {string|null} The name of the first numeric column, or null if none is found.
         */
        function findFirstNumericColumn(data, columns) {
            if (!data || data.length === 0 || columns.length === 0) return null;

            for (const col of columns) {
                // Check the first few rows (e.g., 10) to see if the column is likely numeric
                const sampleSize = Math.min(data.length, 10);
                let numericCount = 0;

                for (let i = 0; i < sampleSize; i++) {
                    const value = data[i][col];
                    // Check if the value is a number and not NaN
                    if (typeof value === 'number' && !isNaN(value)) {
                        numericCount++;
                    }
                }

                // If more than half of the sample size are numeric, consider it a numeric column
                if (numericCount > sampleSize / 2) {
                    return col;
                }
            }

            return null;
        }

        /**
         * Checks if all specified columns are predominantly numeric.
         * @param {Array<string>} colsToCheck - Array of column names to check.
         * @returns {boolean} True if all columns are considered numeric.
         */
        function areColumnsNumeric(colsToCheck) {
            if (!colsToCheck || colsToCheck.length === 0) return false;

            for (const col of colsToCheck) {
                const values = rawData.map(r => r[col]).filter(v => v != null); // Get non-null values
                if (values.length === 0) return false; // Empty column is not numeric

                const numericCount = values.filter(v => typeof v === 'number' && !isNaN(v)).length;
                
                // If less than 80% of non-null values are numeric, treat it as non-numeric
                if ((numericCount / values.length) < 0.8) { 
                    return false;
                }
            }
            return true;
        }

        // ===================================================================================
        // UI Rendering Functions
        // ===================================================================================

        /**
         * Renders a preview of the first 10 rows of data in a table.
         * Uses textContent for cell data to prevent XSS from data values.
         */
        function renderDataPreview() {
            const table = document.getElementById('data-preview-table');
            table.innerHTML = '';
            
            // Create table header
            const thead = table.createTHead();
            const headerRow = thead.insertRow();
            columns.forEach(col => {
                const th = document.createElement('th');
                // Use textContent to safely render column names, preventing XSS
                th.textContent = col;
                th.className = 'px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky top-0 bg-gray-100';
                headerRow.appendChild(th);
            });

            // Create table body with preview data
            const tbody = table.createTBody();
            const rowsToShow = Math.min(rawData.length, 10);
            for (let i = 0; i < rowsToShow; i++) {
                const row = tbody.insertRow();
                columns.forEach(col => {
                    const cell = row.insertCell();
                    const value = rawData[i][col];
                    // Use textContent to safely render cell data
                    cell.textContent = value ?? ''; // Use nullish coalescing for cleaner code
                    cell.className = 'px-4 py-2 whitespace-nowrap text-sm text-gray-500';
                });
            }
        }

        /**
         * Helper function to calculate basic statistics for an array of numbers.
         * @param {Array<number>} values - Array of numerical data.
         * @returns {Object} An object containing statistical measures.
         */
        function calculateStats(values) {
            if (values.length === 0) {
                return { count: 0, mean: NaN, std: NaN, min: NaN, '25%': NaN, '50%': NaN, '75%': NaN, max: NaN };
            }
            const sorted = [...values].sort((a, b) => a - b);
            const n = sorted.length;
            const mean = values.reduce((s, v) => s + v, 0) / n;
            const variance = n > 1 ? values.map(v => (v - mean) ** 2).reduce((s, v) => s + v, 0) / (n - 1) : 0;
            const std = Math.sqrt(variance);
            const quantile = (arr, q) => {
                const pos = (arr.length) * q;
                const base = Math.floor(pos);
                const rest = pos - base;
                if (base < 1) return arr[0];
                if (base >= arr.length) return arr[arr.length - 1];
                return arr[base - 1] + rest * (arr[base] - arr[base - 1]);
            };
            return { 
                count: n, 
                mean, 
                std, 
                min: sorted[0], 
                '25%': quantile(sorted, 0.25), 
                '50%': quantile(sorted, 0.5), 
                '75%': quantile(sorted, 0.75), 
                max: sorted[n - 1] 
            };
        }

        /**
         * Renders a table with summary statistics for all numeric columns.
         * Sanitizes column headers before inserting them as HTML.
         */
        function renderSummaryStatistics() {
            const container = document.getElementById('summary-statistics-container');
            const section = document.getElementById('summary-statistics-section');
            const downloadBtn = document.getElementById('download-summary-btn');
            const t = translations[currentLang];

            container.innerHTML = '';
            downloadBtn.disabled = true; 
            
            const numericColumns = columns.filter(c => 
                rawData.some(r => typeof r[c] === 'number' && !isNaN(r[c]))
            );

            if (numericColumns.length === 0) {
                section.classList.add('hidden');
                container.innerHTML = `<p class="text-gray-500 italic">${t.noNumericData}</p>`;
                calculatedSummaryStats = {};
                return;
            }
            
            // Calculate and cache statistics
            const stats = {};
            numericColumns.forEach(col => {
                const values = rawData.map(r => r[col]).filter(v => typeof v === 'number' && !isNaN(v));
                stats[col] = calculateStats(values);
            });
            calculatedSummaryStats = stats;

            const statLabels = t.statLabels;
            const statKeys = ['count', 'mean', 'std', 'min', '25%', '50%', '75%', 'max'];
            
            let html = `<table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-100 sticky-stat-label">${statLabels.statistic}</th>`;
            numericColumns.forEach(col => { 
                // Sanitize column headers before inserting into the HTML string
                html += `<th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">${sanitizeHTML(col)}</th>`; 
            });
            html += `</tr></thead><tbody class="bg-white divide-y divide-gray-200">`;
            statKeys.forEach(key => {
                html += `<tr><td class="px-4 py-2 whitespace-nowrap text-sm font-bold text-gray-700 sticky left-0 bg-white sticky-stat-label">${statLabels[key]}</td>`;
                numericColumns.forEach(col => {
                    const value = stats[col][key];
                    const displayValue = isNaN(value) ? '-' : value.toFixed(3);
                    html += `<td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500 text-right">${displayValue}</td>`;
                });
                html += `</tr>`;
            });
            html += `</tbody></table>`;

            container.innerHTML = html;
            section.classList.remove('hidden');
            downloadBtn.disabled = false;
        }

        /**
         * Downloads the calculated summary statistics as a CSV file.
         */
        function downloadSummaryStatistics() {
            const t = translations[currentLang];
            const stats = calculatedSummaryStats;
            const numericColumns = Object.keys(stats);
            if (numericColumns.length === 0) { 
                alert(t.downloadStatsError); 
                return; 
            }

            const statLabels = t.statLabels;
            const statKeys = ['count', 'mean', 'std', 'min', '25%', '50%', '75%', 'max'];
            let csv = [`"${statLabels.statistic}"`, ...numericColumns].join(',') + '\n';
            statKeys.forEach(key => {
                let row = [`"${statLabels[key]}"`];
                numericColumns.forEach(col => {
                    const value = stats[col][key];
                    row.push(isNaN(value) ? '' : value.toFixed(3));
                });
                csv += row.join(',') + '\n';
            });

            // Create and trigger a download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const now = new Date();
            const filename = `summary_stats_${now.toISOString().slice(0,10).replace(/-/g,"")}.csv`;
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        /**
         * Dynamically generates the UI controls for configuring the selected chart type.
         */
        function renderChartConfigUI() {
            if (columns.length === 0) return;

            const chartType = chartTypeSelect.value;
            chartConfigArea.innerHTML = ''; 
            downloadImageBtn.disabled = true; 
            const t = translations[currentLang];
            const labels = t.configLabels;
            const numericColumns = columns.filter(c => 
                rawData.some(r => typeof r[c] === 'number' && !isNaN(r[c]))
            );
            
            // Find the first numeric column for default selection
            const defaultNumericCol = findFirstNumericColumn(rawData, columns); 

            // Helper to create a <select> element
            const createSelect = (id, labelText, options, isMultiple = false, size = 1, defaultValue = '', parentElement = chartConfigArea) => {
                const div = document.createElement('div');
                div.className = 'space-y-1';
                const label = Object.assign(document.createElement('label'), 
                    { htmlFor: id, className: 'block text-sm font-medium text-gray-700', textContent: labelText });
                const select = Object.assign(document.createElement('select'), 
                    { id, className: 'w-full p-2 border border-gray-300 rounded-md' });
                
                if (isMultiple) { 
                    select.multiple = true; 
                    select.size = size; 
                    select.classList.add('h-auto'); 
                } else { 
                    select.add(new Option(t.selectOptionDefault, '')); 
                }

                options.forEach(col => select.add(new Option(col, col)));
                
                // Set default value if provided and exists in options
                if (defaultValue && select.querySelector(`option[value="${defaultValue}"]`)) {
                    select.value = defaultValue;
                }
                
                div.append(label, select);
                parentElement.appendChild(div);
            };

            // Helper to create an <input> element
            const createInput = (id, labelText, type = 'text', defaultValue) => {
                const div = document.createElement('div');
                div.className = 'space-y-1';
                const label = Object.assign(document.createElement('label'), 
                    { htmlFor: id, className: 'block text-sm font-medium text-gray-700', textContent: labelText });
                const input = Object.assign(document.createElement('input'), 
                    { type, id, value: defaultValue, className: 'w-full p-2 border border-gray-300 rounded-md' });
                div.append(label, input);
                chartConfigArea.appendChild(div);
            };

            // Helper to create a group of radio buttons
            const createRadioGroup = (name, labelText, options) => {
                const div = document.createElement('div');
                div.className = 'space-y-1';
                const label = Object.assign(document.createElement('label'), 
                    { className: 'block text-sm font-medium text-gray-700', textContent: labelText });
                const groupDiv = document.createElement('div');
                groupDiv.className = 'flex flex-wrap gap-4';

                options.forEach(([value, text], index) => {
                    const id = `${name}-${value}`;
                    const radioDiv = document.createElement('div');
                    radioDiv.className = 'flex items-center';
                    const radio = Object.assign(document.createElement('input'), 
                        { type: 'radio', name, id, value, className: 'h-4 w-4 text-blue-600 border-gray-300', checked: index === 0 });
                    const radioLabel = Object.assign(document.createElement('label'), 
                        { htmlFor: id, className: 'ml-2 block text-sm text-gray-700', textContent: text });
                    radioDiv.append(radio, radioLabel);
                    groupDiv.appendChild(radioDiv);
                });

                div.append(label, groupDiv);
                chartConfigArea.appendChild(div);
            };

            // Generate UI based on the selected chart type
            switch (chartType) {
                case 'histogram':
                    createSelect('column-selector-x', labels.xAxisData, numericColumns);
                    createSelect('column-selector-color', labels.colorGroup, columns); 
                    createInput('histogram-n-bins', labels.nBins, 'number', 10);
                    break;
                case 'box':
                    // --- Container for Y-axis Data Column(s) ---
                    const dataContainer = document.createElement('div');
                    dataContainer.className = 'mb-4 p-3 border border-gray-200 rounded-lg bg-gray-50';
                    chartConfigArea.appendChild(dataContainer);

                    dataContainer.insertAdjacentHTML('beforeend', `
                        <div class="flex items-center">
                            <input id="multi-data-checkbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                            <label for="multi-data-checkbox" class="ml-2 block text-sm font-medium text-gray-700">${labels.multiGroupCheckbox}</label>
                        </div>
                    `);
                    
                    const singleDataContainer = document.createElement('div');
                    singleDataContainer.id = 'single-data-container';
                    dataContainer.appendChild(singleDataContainer);
                    createSelect('column-selector-y-single', labels.yAxisData, numericColumns, false, 1, defaultNumericCol, singleDataContainer);

                    const multiDataContainer = document.createElement('div');
                    multiDataContainer.id = 'multi-data-container';
                    multiDataContainer.className = 'hidden';
                    dataContainer.appendChild(multiDataContainer);
                    createSelect('column-selector-y-multi', labels.yAxisDataMulti, numericColumns, true, 4, '', multiDataContainer);
                    const yHint = Object.assign(document.createElement('p'), {
                        className: 'text-xs text-gray-500 mt-1', textContent: t.yAxisMultiSelectHint
                    });
                    multiDataContainer.querySelector('div').appendChild(yHint);
                    
                    document.getElementById('multi-data-checkbox').addEventListener('change', (e) => {
                        singleDataContainer.classList.toggle('hidden', e.target.checked);
                        multiDataContainer.classList.toggle('hidden', !e.target.checked);
                    });
                    
                    // --- Container for X-axis Grouping Column(s) ---
                    const groupContainer = document.createElement('div');
                    groupContainer.className = 'mt-2 p-3 border border-gray-200 rounded-lg bg-gray-50';
                    chartConfigArea.appendChild(groupContainer);

                    groupContainer.insertAdjacentHTML('beforeend', `
                        <div class="flex items-center">
                            <input id="multi-group-checkbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                            <label for="multi-group-checkbox" class="ml-2 block text-sm font-medium text-gray-700">${labels.multiGroupCheckbox}</label>
                        </div>
                    `);
                    
                    const singleGroupContainer = document.createElement('div');
                    singleGroupContainer.id = 'single-group-container';
                    groupContainer.appendChild(singleGroupContainer);
                    createSelect('column-selector-group', labels.groupColumn, columns, false, 1, '', singleGroupContainer);
                    
                    const multiGroupContainer = document.createElement('div');
                    multiGroupContainer.id = 'multi-group-container';
                    multiGroupContainer.className = 'hidden';
                    groupContainer.appendChild(multiGroupContainer);
                    createSelect('column-selector-group-multi', labels.groupColumns, columns, true, 4, '', multiGroupContainer);
                    const xHint = Object.assign(document.createElement('p'), {
                        className: 'text-xs text-gray-500 mt-1', textContent: t.yAxisMultiSelectHint
                    });
                    multiGroupContainer.querySelector('div').appendChild(xHint);
                    
                    document.getElementById('multi-group-checkbox').addEventListener('change', (e) => {
                        singleGroupContainer.classList.toggle('hidden', e.target.checked);
                        multiGroupContainer.classList.toggle('hidden', !e.target.checked);
                    });
                    break;
                case 'bar':
                    createSelect('column-selector-x', labels.xAxisLabel, [t.indexOption, ...columns]);
                    createSelect('column-selector-y', labels.yAxisValue, columns);
                    break;
                case 'line':
                    createSelect('column-selector-x', labels.xAxisLabel, [t.indexOption, ...columns]);
                    createSelect('column-selector-y', labels.yAxisMulti, numericColumns, true, 5);
                    const lineHint = Object.assign(document.createElement('p'), {
                        className: 'text-xs text-gray-500 mt-1',
                        textContent: t.yAxisMultiSelectHint
                    });
                    chartConfigArea.appendChild(lineHint);
                    break;
                case 'scatter':
                    createSelect('column-selector-x', labels.xAxisData, numericColumns);
                    createSelect('column-selector-y', labels.yAxisData, numericColumns);
                    createSelect('column-selector-color', labels.colorGroup, columns);
                    createRadioGroup('regression-type', labels.regressionLine, Object.entries(labels.regression));
                    break;
                //case 'pairplot':
                //    createSelect('column-selector-group', labels.colorGroup, columns);
                //    break;
                case 'pareto':
                    // Container for category options
                    const paretoCatContainer = document.createElement('div');
                    paretoCatContainer.className = 'space-y-2';
                    chartConfigArea.appendChild(paretoCatContainer);

                    // Checkbox
                    paretoCatContainer.insertAdjacentHTML('beforeend', `
                        <div class="flex items-center">
                            <input id="multi-category-checkbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                            <label for="multi-category-checkbox" class="ml-2 block text-sm font-medium text-gray-700">${labels.multiGroupCheckbox}</label>
                        </div>
                    `);

                    // Single-select container (visible by default)
                    const singleCatContainer = document.createElement('div');
                    singleCatContainer.id = 'single-category-container';
                    paretoCatContainer.appendChild(singleCatContainer);
                    createSelect('pareto-category-col', labels.paretoCategory, columns, false, 1, '', singleCatContainer);
                    
                    // Multi-select container (hidden by default)
                    const multiCatContainer = document.createElement('div');
                    multiCatContainer.id = 'multi-category-container';
                    multiCatContainer.className = 'hidden';
                    paretoCatContainer.appendChild(multiCatContainer);
                    createSelect('pareto-category-col-multi', labels.paretoCategories, columns, true, 4, '', multiCatContainer);
                    const paretoHint = Object.assign(document.createElement('p'), {
                        className: 'text-xs text-gray-500 mt-1',
                        textContent: t.yAxisMultiSelectHint
                    });
                    multiCatContainer.querySelector('div').appendChild(paretoHint);
                    
                    // Event listener for the checkbox
                    document.getElementById('multi-category-checkbox').addEventListener('change', (e) => {
                        singleCatContainer.classList.toggle('hidden', e.target.checked);
                        multiCatContainer.classList.toggle('hidden', !e.target.checked);
                    });

                    // Other pareto settings
                    createSelect('pareto-value-col', labels.paretoValue, [labels.paretoValueOption, ...columns]);
                    createInput('pareto-top-n', labels.paretoTopN, 'number', 10);
                    chartConfigArea.insertAdjacentHTML('beforeend', `
                        <div class="flex items-center">
                            <input id="pareto-exclude-other" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded">
                            <label for="pareto-exclude-other" class="ml-2 block text-sm text-gray-700">${labels.paretoExcludeOther}</label>
                        </div>`);
                    break;
                case 'xrs_control_chart':
                    createSelect('xrs-data-col', labels.xrsData, columns);
                    break;
                default: 
                    chartConfigArea.innerHTML = `<p class="text-red-500">${t.errorNotImplemented}</p>`;
            }
        }

        // ===================================================================================
        // Chart Drawing
        // ===================================================================================

        /**
         * Main function to draw the selected chart. Acts as a router to specific drawing functions.
         */
        function drawChart() {
            const chartType = chartTypeSelect.value;
            const t = translations[currentLang];
            chartContainer.innerHTML = ''; 
            drawChartButton.disabled = true;
            downloadImageBtn.disabled = true; 

            try {
                // Map chart types to their respective drawing functions
                const drawFunctions = {
                    'histogram': drawBasicChart,
                    'box': drawBasicChart,
                    'bar': drawBasicChart, 
                    'line': drawBasicChart,
                    'scatter': drawBasicChart,
                    //'pairplot': drawPairPlot, 
                    'pareto': drawParetoChart,
                    'xrs_control_chart': drawXRsaChart
                };
                
                if (drawFunctions[chartType]) {
                    drawFunctions[chartType](chartType);
                } else {
                    chartContainer.innerHTML = `<p class="text-red-500 text-center pt-20">${t.errorNotImplemented}</p>`;
                }
                downloadImageBtn.disabled = false;
            } catch (error) {
                console.error('Chart drawing error:', error);
                chartContainer.innerHTML = `<div class="p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg text-center mt-4">
                    <p class="font-bold">${t.errorDrawingChart}</p>
                    <p class="text-sm">${sanitizeHTML(error.message) || t.errorCheckSettings}</p>
                </div>`;
                downloadImageBtn.disabled = true; 
            } finally {
                drawChartButton.disabled = false;
            }
        }
        
        /**
         * Helper to get all selected values from a multi-select dropdown.
         * @param {string} selectId - The ID of the select element.
         * @returns {Array<string>} An array of selected values.
         */
        function getSelectedValues(selectId) {
            const select = document.getElementById(selectId);
            if (!select) return [];
            return Array.from(select.selectedOptions).map(option => option.value);
        }

        /**
         * Draws basic charts like histogram, box, bar, line, and scatter.
         * @param {string} type - The type of basic chart to draw.
         */
        function drawBasicChart(type) {
            const t = translations[currentLang];
            let traces = [];
            const layout = { 
                margin: { t: 50, b: 40, l: 50, r: 20 }, 
                height: 550, 
                hovermode: 'closest',
                xaxis: { automargin: true },
                yaxis: { automargin: true }
            };

            // Get values from UI controls
            const xCol = document.getElementById('column-selector-x')?.value;
            const yCols = getSelectedValues('column-selector-y');
            const colorCol = document.getElementById('column-selector-color')?.value;
            const regressionType = document.querySelector('input[name="regression-type"]:checked')?.value || 'none';
            const firstYCol = yCols[0] || '';
            const xIsIndex = (type === 'bar' || type === 'line') && xCol === t.indexOption;
            
            // --- Input Validation for non-box charts ---
            if (type !== 'box') {
                if (!xCol) throw new Error(t.errorMissingData);
                if ((type === 'bar' || type === 'line') && xCol === '') throw new Error(t.errorMissingX);
                if ((type === 'bar' || type === 'line' || type === 'scatter') && yCols.length === 0) throw new Error(t.errorMissingY);
            }
            
            // --- Chart Title Generation ---
            // Sanitize user-provided title to prevent XSS
            const chartTitleInput = sanitizeHTML(document.getElementById('chart-title').value.trim());

            switch (type) {
                case 'box':
                    const isMultiData = document.getElementById('multi-data-checkbox')?.checked;
                    const dataCols = isMultiData ? getSelectedValues('column-selector-y-multi') : [document.getElementById('column-selector-y-single')?.value];
                    const activeDataCols = dataCols.filter(c => c);

                    const isMultiGroup = document.getElementById('multi-group-checkbox')?.checked;
                    const groupColsRaw = isMultiGroup ? getSelectedValues('column-selector-group-multi') : [document.getElementById('column-selector-group')?.value];
                    const activeGroupCols = groupColsRaw.filter(c => c);
                    
                    if (activeDataCols.length === 0) throw new Error(t.errorBoxData);

                    // Set sanitized title for the chart layout
                    layout.title = chartTitleInput || `${activeDataCols.join(', ')}${activeGroupCols.length > 0 ? ` by ${activeGroupCols.join(', ')}` : ''} ${t.chartTypes.box}`;
                    const groupingActive = activeGroupCols.length > 0;

                    if (groupingActive) {
                        const groupedData = rawData.reduce((acc, row) => {
                            const key = activeGroupCols.map(col => String(row[col] ?? '(null)')).join(' | ');
                            (acc[key] = acc[key] || []).push(row);
                            return acc;
                        }, {});
                        let groupKeys = Object.keys(groupedData);

                        if (areColumnsNumeric(activeGroupCols)) {
                            groupKeys.sort((a, b) => {
                                const partsA = a.split(' | ').map(Number);
                                const partsB = b.split(' | ').map(Number);
                                if (partsA.some(isNaN) || partsB.some(isNaN)) return a.localeCompare(b);
                                for (let i = 0; i < Math.min(partsA.length, partsB.length); i++) {
                                    if (partsA[i] !== partsB[i]) return partsA[i] - partsB[i];
                                }
                                return partsA.length - partsB.length;
                            });
                        } else {
                            groupKeys.sort();
                        }
                        
                        activeDataCols.forEach(dataCol => {
                            const x_categories_for_trace = [];
                            const y_values_for_trace = [];
                            groupKeys.forEach(groupKey => {
                                const numericData = groupedData[groupKey].map(r => r[dataCol]).filter(v => typeof v === 'number' && !isNaN(v));
                                if (numericData.length > 0) {
                                    y_values_for_trace.push(...numericData);
                                    x_categories_for_trace.push(...Array(numericData.length).fill(groupKey));
                                }
                            });
                            if (y_values_for_trace.length > 0) {
                                traces.push({ x: x_categories_for_trace, y: y_values_for_trace, name: dataCol, type: 'box', boxpoints: 'all' });
                            }
                        });
                        layout.boxmode = 'group';
                        layout.xaxis.title = activeGroupCols.join(', ');
                        layout.yaxis.title = activeDataCols.length > 1 ? 'Value' : activeDataCols[0];
                    } else {
                        activeDataCols.forEach(dataCol => {
                            const yValues = rawData.map(d => d[dataCol]).filter(v => typeof v === 'number' && !isNaN(v));
                            if (yValues.length > 0) {
                                traces.push({ y: yValues, name: dataCol, type: 'box', boxpoints: 'all' });
                            }
                        });
                        layout.xaxis.title = 'Variable';
                        layout.yaxis.title = 'Value';
                    }
                    break;

                case 'histogram':
                case 'scatter':
                    layout.title = chartTitleInput || `${xCol}${firstYCol ? ` vs ${firstYCol}`:''} ${t.chartTypes[type]}`;
                    const colorGroupingActive = colorCol;
                    let colorGroupedData = { 'all': rawData };
                    let colorGroupKeys = ['all'];

                    if (colorGroupingActive) {
                        colorGroupedData = rawData.reduce((acc, row) => {
                            const key = String(row[colorCol] ?? '(null)');
                            (acc[key] = acc[key] || []).push(row);
                            return acc;
                        }, {});
                        colorGroupKeys = Object.keys(colorGroupedData).sort();
                    }

                    colorGroupKeys.forEach(key => {
                        const groupRows = colorGroupedData[key];
                        const groupName = key === 'all' ? (firstYCol || xCol) : key;
                        
                        if (type === 'histogram') {
                            const xValues = groupRows.map(d => d[xCol]).filter(v => typeof v === 'number' && !isNaN(v));
                            const nBins = parseInt(document.getElementById('histogram-n-bins')?.value) || 10;
                            traces.push({ x: xValues, type: 'histogram', name: groupName, opacity: 0.7, nbinsx: nBins });
                        } else { // scatter
                            traces.push({ 
                                x: groupRows.map(d => d[xCol]), 
                                y: groupRows.map(d => d[firstYCol]), 
                                mode: 'markers', type: 'scatter', name: groupName 
                            });
                        }
                    });
                    
                    if (type === 'histogram') {
                        layout.barmode = 'overlay';
                        layout.xaxis.title = xCol;
                        layout.yaxis.title = 'Frequency';
                    } else { // scatter
                        layout.showlegend = !!colorCol;
                        layout.xaxis.title = xCol;
                        layout.yaxis.title = firstYCol;
                        if (regressionType === 'linear') {
                            const validPoints = rawData.filter(d => typeof d[xCol] === 'number' && typeof d[firstYCol] === 'number');
                            const xVals = validPoints.map(d => d[xCol]);
                            const yVals = validPoints.map(d => d[firstYCol]);
                            if (xVals.length > 1) {
                                const n = xVals.length;
                                const sumX = xVals.reduce((a, b) => a + b, 0), sumY = yVals.reduce((a, b) => a + b, 0);
                                const sumXY = xVals.reduce((s, x, i) => s + x * yVals[i], 0), sumXX = xVals.reduce((s, x) => s + x * x, 0);
                                const b = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                                const a = (sumY / n) - b * (sumX / n);
                                const xMin = Math.min(...xVals), xMax = Math.max(...xVals);
                                traces.push({ x: [xMin, xMax], y: [a + b * xMin, a + b * xMax], mode: 'lines', type: 'scatter', line: { color: 'red' }, name: t.configLabels.regression.linear });
                            }
                        }
                    }
                    break;

                case 'bar':
                case 'line':
                    const xData = xIsIndex ? rawData.map((_, i) => i + 1) : rawData.map(d => d[xCol]);
                    layout.title = chartTitleInput || `${xIsIndex ? 'Index' : xCol} vs ${yCols.join(', ')} ${t.chartTypes[type]}`;
                    layout.xaxis.title = xIsIndex ? 'Index' : xCol;
                    layout.xaxis.type = xIsIndex ? 'linear' : 'category';
                    layout.yaxis.title = 'Value';

                    if (type === 'bar') {
                        traces.push({ x: xData, y: rawData.map(d => d[firstYCol]), type: 'bar', name: firstYCol });
                    } else { // line
                        yCols.forEach(yCol => traces.push({ x: xData, y: rawData.map(d => d[yCol]), mode: 'lines', type: 'scatter', name: yCol }));
                        layout.showlegend = yCols.length > 1;
                    }
                    break;
            }

            Plotly.newPlot(chartContainer, traces, layout, { responsive: true });
        }

        /**
         * Draws a pair plot (scatter plot matrix).
         */
        function drawPairPlot() {
            const groupCol = document.getElementById('column-selector-group')?.value;
            const numericColumns = columns.filter(c => rawData.some(r => typeof r[c] === 'number' && !isNaN(r[c])));
            
            if (numericColumns.length < 2) {
                throw new Error(translations[currentLang].errorPairPlot);
            }
        
            const dimensions = numericColumns.map(col => ({ 
                label: col, 
                values: rawData.map(d => d[col]) 
            }));
        
            const marker = { size: 4, opacity: 0.8 };
            if (groupCol) {
                // Create a mapping from unique group values to integers for coloring
                const uniqueGroups = [...new Set(rawData.map(d => d[groupCol]))];
                const colorMap = uniqueGroups.reduce((acc, val, i) => {
                    acc[val] = i;
                    return acc;
                }, {});
                marker.color = rawData.map(d => colorMap[d[groupCol]]);
                // Add colorbar if you want a legend for the colors
                // marker.colorbar = { title: groupCol };
            }
            
            const trace = { 
                type: 'splom', 
                dimensions, 
                showlowerhalf: true, 
                showupperhalf: false, 
                marker, 
                diagonal: { visible: false } 
            };
            
            const chartTitleInput = sanitizeHTML(document.getElementById('chart-title').value.trim());
            const chartTitle = chartTitleInput || `${translations[currentLang].chartTypes.pairplot}${groupCol ? ` - Group: ${groupCol}` : ''}`;
            
            const layout = { title: chartTitle, height: 700, autosize: true, hovermode: 'closest' };
            Plotly.newPlot(chartContainer, [trace], layout, { responsive: true });
        }

        /**
         * Draws a Pareto chart.
         */
        function drawParetoChart() {
            const isMultiCategory = document.getElementById('multi-category-checkbox')?.checked;
            const categoryCols = (isMultiCategory 
                ? getSelectedValues('pareto-category-col-multi') 
                : [document.getElementById('pareto-category-col')?.value])
                .filter(c => c); // Filter out empty strings from selection

            const valueColRaw = document.getElementById('pareto-value-col').value;
            const topN = parseInt(document.getElementById('pareto-top-n').value) || 10;
            const excludeOther = document.getElementById('pareto-exclude-other').checked;
            const t = translations[currentLang];
            
            if (categoryCols.length === 0) throw new Error(t.errorParetoCategory);

            const valueCol = valueColRaw === t.configLabels.paretoValueOption ? null : valueColRaw;
            
            // Aggregate data by category
            const aggregatedData = rawData.reduce((acc, row) => {
                let isValid = true;
                const categoryValues = categoryCols.map(col => {
                    const val = row[col];
                    if (val == null) { // checks for null and undefined
                        isValid = false;
                    }
                    return String(val ?? '(null)');
                });

                if (isValid) {
                    const categoryKey = categoryValues.join(' | ');
                    const value = valueCol ? (typeof row[valueCol] === 'number' ? row[valueCol] : 0) : 1;
                    acc[categoryKey] = (acc[categoryKey] || 0) + value;
                }
                return acc;
            }, {});

            // Sort data by value in descending order
            let sorted = Object.entries(aggregatedData)
                .sort(([,a],[,b]) => b - a)
                .map(([category, value]) => ({category, value}));
            
            // Handle "Top N" and "Other" categories
            let displayData = sorted.slice(0, topN);
            let otherValue = sorted.slice(topN).reduce((sum, item) => sum + item.value, 0);
            if (otherValue > 0 && !excludeOther) {
                displayData.push({ category: 'Other', value: otherValue });
            }

            // Calculate cumulative ratio
            const total = displayData.reduce((s, i) => s + i.value, 0);
            let cumulative = 0;
            displayData.forEach(d => { 
                cumulative += d.value; 
                d.cumulativeRatio = (cumulative / total) * 100; 
            });
            
            // Create numeric indices for positioning, and category labels for display.
            const x_indices = displayData.map((_, i) => i);
            const categories = displayData.map(d => d.category);
            const values = displayData.map(d => d.value);
            const ratios = displayData.map(d => d.cumulativeRatio);

            // The bar trace uses the integer indices, which will center the bars.
            const barTrace = { x: x_indices, y: values, type: 'bar', name: 'Value', yaxis: 'y1' };

            // The line trace indices are offset to align with the right edge of the bars.
            // A standard bar at index `i` spans from `i-0.4` to `i+0.4`. We shift the marker to `i+0.4`.
            const line_x_indices = x_indices.map(i => i + 0.4);
            const lineTrace = { x: line_x_indices, y: ratios, type: 'scatter', mode: 'lines+markers', name: 'Cumulative %', yaxis: 'y2' };
            
            const chartTitleInput = sanitizeHTML(document.getElementById('chart-title').value.trim());
            const chartTitle = chartTitleInput || `${categoryCols.join(', ')} ${t.chartTypes.pareto}`;
            
            const layout = { 
                title: chartTitle, 
                height: 550, 
                // Use a linear axis but with category labels for ticks.
                xaxis: { 
                    tickvals: x_indices,
                    ticktext: categories,
                    // Adjust range to ensure the last marker (at n-1 + 0.4) is visible.
                    range: [-0.75, x_indices.length - 0.5]
                },
                yaxis: { title: 'Value' },
                // Increase range slightly to prevent 100% marker from touching the top border
                yaxis2: { title: 'Cumulative Ratio (%)', overlaying: 'y', side: 'right', range: [0, 105] },
                // Add a horizontal line at 80% for Pareto analysis
                shapes: [{
                    type: 'line',
                    xref: 'paper', // Use 'paper' to span the whole plot width
                    yref: 'y2',    // Refer to the secondary y-axis
                    x0: 0,
                    y0: 80,
                    x1: 1,
                    y1: 80,
                    line: {
                        color: 'red',
                        width: 2,
                        dash: 'dot'
                    }
                }]
            };
            Plotly.newPlot(chartContainer, [barTrace, lineTrace], layout, { responsive: true });
        }

        /**
         * Draws an X-bar and R-s (X-Rs) control chart.
         */
        function drawXRsaChart() {
            const dataCol = document.getElementById('xrs-data-col').value;
            const t = translations[currentLang];
            if (!dataCol) throw new Error(t.errorMissingData);

            const values = rawData.map(r => r[dataCol]).filter(v => typeof v === 'number' && !isNaN(v));
            if (values.length < 2) throw new Error(t.errorXRData);
            
            // Calculate Moving Range (Rs)
            const indices = values.map((_, i) => i + 1);
            const MR = [null, ...values.slice(1).map((v, i) => Math.abs(v - values[i]))];
            const validMR = MR.filter(v => v != null);
            if (validMR.length === 0) throw new Error(t.errorMRData);
            
            // Calculate center lines
            const X_bar = values.reduce((s, v) => s + v, 0) / values.length;
            const MR_bar = validMR.reduce((s, v) => s + v, 0) / validMR.length;
            const { E2, D4 } = CONTROL_CHART_COEFFICIENTS[2];

            // Calculate control limits
            const UCL_X = X_bar + E2 * MR_bar, CL_X = X_bar, LCL_X = X_bar - E2 * MR_bar;
            const UCL_MR = D4 * MR_bar, CL_MR = MR_bar, LCL_MR = 0;

            // Define traces for X chart
            const xTraces = [
                { x: indices, y: values, mode: 'lines', name: 'X' },
                { x: indices, y: Array(values.length).fill(UCL_X), mode: 'lines', name: 'UCL (X)', line: { dash: 'dash', color: 'red' } },
                { x: indices, y: Array(values.length).fill(CL_X), mode: 'lines', name: 'CL (X)', line: { dash: 'dot', color: 'black' } },
                { x: indices, y: Array(values.length).fill(LCL_X), mode: 'lines', name: 'LCL (X)', line: { dash: 'dash', color: 'red' } }
            ];
            // Define traces for Rs chart
            const mrTraces = [
                { x: indices, y: MR, mode: 'lines', name: 'Rs', yaxis: 'y2', xaxis: 'x2'},
                { x: indices, y: Array(values.length).fill(UCL_MR), mode: 'lines', name: 'UCL (Rs)', line: { dash: 'dash', color: 'red' }, yaxis: 'y2', xaxis: 'x2'},
                { x: indices, y: Array(values.length).fill(CL_MR), mode: 'lines', name: 'CL (Rs)', line: { dash: 'dot', color: 'black' }, yaxis: 'y2', xaxis: 'x2'},
                { x: indices, y: Array(values.length).fill(LCL_MR), mode: 'lines', name: 'LCL (Rs)', line: { dash: 'dash', color: 'red' }, yaxis: 'y2', xaxis: 'x2'}
            ];

            const chartTitleInput = sanitizeHTML(document.getElementById('chart-title').value.trim());
            const chartTitle = chartTitleInput || `${dataCol} ${t.chartTypes.xrs_control_chart}`;
            
            const layout = { 
                title: chartTitle, 
                height: 800, 
                grid: { rows: 2, columns: 1, pattern: 'independent' },
                yaxis: { title: 'X (Value)' }, 
                yaxis2: { title: 'Rs (Moving Range)' }, 
                showlegend: false 
            };

            Plotly.newPlot(chartContainer, [...xTraces, ...mrTraces], layout, { responsive: true });
        }
        
        /**
         * Downloads the currently displayed chart as a PNG image.
         */
         function downloadChartAsImage() {
            const t = translations[currentLang];
            if (!chartContainer || !chartContainer.data) {
                 alert(t.downloadImageError);
                 return;
            }

            Plotly.toImage(chartContainer, { format: 'png', width: 1200, height: 750 })
                .then(function(dataUrl) {
                    // Convert the data URI to a Blob and download it
                    const byteString = atob(dataUrl.split(',')[1]);
                    const mimeString = dataUrl.split(',')[0].split(':')[1].split(';')[0];
                    const ab = new ArrayBuffer(byteString.length);
                    const ia = new Uint8Array(ab);
                    for (let i = 0; i < byteString.length; i++) {
                        ia[i] = byteString.charCodeAt(i);
                    }
                    const blob = new Blob([ab], { type: mimeString });
                    const blobUrl = URL.createObjectURL(blob);

                    const link = document.createElement('a');
                    link.href = blobUrl;
                    const now = new Date();
                    link.download = `chart_${now.toISOString().slice(0,10).replace(/-/g,"")}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Release the generated URL to prevent memory leaks
                    URL.revokeObjectURL(blobUrl);
                }).catch(err => {
                    console.error('Image download error:', err);
                    alert(t.downloadImageError);
                });
        }

        // ===================================================================================
        // Application Startup
        // ===================================================================================
        initializeApp();
    </script>
</body>
</html>
