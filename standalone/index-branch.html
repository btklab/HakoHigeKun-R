<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‹ã‚“ãŸã‚“ã‚°ãƒ©ãƒ•ä½œæˆã‚¢ãƒ—ãƒª (HTML+Plotly)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        /* ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ«: ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®å¹…ã¨ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®èª¿æ•´ */
        .sidebar {
            width: 320px;
            min-width: 320px;
        }
        .main-content {
            flex-grow: 1;
        }
        /* Plotlyã®æç”»é ˜åŸŸã®é«˜ã•è¨­å®š */
        #chart-container {
            min-height: 600px;
        }
        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª¿æ•´ã—ã¦è¦‹ã‚„ã™ã */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }
        ::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
    <!-- FIX: alert()ã®ä»£ã‚ã‚Šã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’è¿½åŠ  -->
    <div id="message-container" class="fixed top-0 left-1/2 -translate-x-1/2 z-50 p-4 w-full max-w-md"></div>
    
    <header class="bg-white shadow-md p-4 flex items-center justify-between z-10">
        <h1 class="text-xl font-bold text-gray-800">ğŸ“Š ã‹ã‚“ãŸã‚“ã‚°ãƒ©ãƒ•ä½œæˆã‚¢ãƒ—ãƒª</h1>
        <div class="flex items-center space-x-2">
            <!-- ãƒœã‚¿ãƒ³ã®ä¿®æ­£ã¯ä¸è¦ã€‚onClickã¯downloadChartAsImage()ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã€‚ -->
            <button id="downloadChartBtn" onclick="downloadChartAsImage()" class="flex items-center bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-lg disabled:opacity-50" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
                <span>ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
            </button>
            <button id="createChartBtn" class="flex items-center bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-150 ease-in-out shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 0 0 6 16.5h2.25M3.75 3h11.25a2.25 2.25 0 0 1 2.25 2.25v2.25m-10.5 7.5a1.5 1.5 0 0 1-3 0v-3a1.5 1.5 0 0 1 3 0m7.5 0a1.5 1.5 0 0 1-3 0v-3a1.5 1.5 0 0 1 3 0m7.5 0a1.5 1.5 0 0 1-3 0v-3a1.5 1.5 0 0 1 3 0" />
                </svg>
                <span>ã‚°ãƒ©ãƒ•ã‚’ä½œæˆ</span>
            </button>
        </div>
    </header>

    <main class="flex-grow flex">
        <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ (ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã¨è¨­å®š) -->
        <aside class="sidebar bg-white p-6 shadow-xl overflow-y-auto flex flex-col space-y-6">
            <h2 class="text-lg font-semibold text-gray-700 border-b pb-2">ãƒ‡ãƒ¼ã‚¿ã¨è¨­å®š</h2>

            <!-- ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
            <section>
                <label for="fileInput" class="block text-sm font-medium text-gray-700 mb-2">â‘  ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ« (.xlsx, .csv) ã‚’é¸æŠ</label>
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
            </section>

            <!-- ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—é¸æŠ -->
            <section>
                <label for="chartType" class="block text-sm font-medium text-gray-700 mb-2">â‘¡ ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—</label>
                <select id="chartType" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    <option value="">-- ã‚°ãƒ©ãƒ•ã‚’é¸æŠ --</option>
                    <option value="line">æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ• (Line)</option>
                    <option value="bar">æ£’ã‚°ãƒ©ãƒ• (Bar)</option>
                    <option value="scatter">æ•£å¸ƒå›³ (Scatter)</option>
                    <option value="histogram">ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ  (Histogram)</option>
                    <option value="xbar">X-bar ç®¡ç†å›³</option>
                    <option value="rs">ç§»å‹•ç¯„å›² R_s ç®¡ç†å›³</option>
                </select>
            </section>

            <!-- Xè»¸é¸æŠ -->
            <section>
                <label for="xAxis" class="block text-sm font-medium text-gray-700 mb-2">â‘¢ Xè»¸ (ã‚«ãƒ†ã‚´ãƒª/æ™‚ç³»åˆ—)</label>
                <select id="xAxis" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm" disabled>
                    <option value="">-- åˆ—ã‚’é¸æŠ --</option>
                </select>
            </section>

            <!-- Yè»¸é¸æŠ -->
            <section>
                <label for="yAxis" class="block text-sm font-medium text-gray-700 mb-2">â‘£ Yè»¸ (æ•°å€¤)</label>
                <select id="yAxis" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm" disabled>
                    <option value="">-- åˆ—ã‚’é¸æŠ --</option>
                </select>
                <p id="yAxisHint" class="text-xs text-gray-500 mt-1 hidden">â€» è¤‡æ•°ã®Yè»¸ã‚’é¸æŠã§ãã¾ã™ (Ctrl/Cmd ã‚­ãƒ¼)</p>
            </section>
            
            <!-- ç®¡ç†å›³ç”¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š -->
            <section id="controlChartParams" class="hidden border-t pt-4 space-y-4">
                <h3 class="text-md font-semibold text-gray-700">ç®¡ç†å›³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h3>
                <div>
                    <label for="subgroupSize" class="block text-sm font-medium text-gray-700 mb-1">ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ã‚µã‚¤ã‚º ($n$)</label>
                    <input type="number" id="subgroupSize" value="5" min="2" class="mt-1 block w-full pl-3 pr-3 py-2 text-base border-gray-300 rounded-md shadow-sm">
                    <p class="text-xs text-gray-500 mt-1">($X$-bar/R ç®¡ç†å›³ã®å ´åˆã«é©ç”¨)</p>
                </div>
            </section>
        </aside>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ (ã‚°ãƒ©ãƒ•æç”»ã‚¨ãƒªã‚¢) -->
        <div class="main-content p-6 flex flex-col">
            <div class="flex-grow flex items-center justify-center">
                <div id="chart-container" class="bg-white p-4 rounded-lg shadow-xl flex-grow overflow-hidden">
                    <p class="text-gray-400 text-center text-xl pt-[20%]">å·¦å´ã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã¨ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã€ã€Œã‚°ãƒ©ãƒ•ã‚’ä½œæˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
            </div>
            
            <!-- ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
            <div class="mt-6 bg-white p-4 rounded-lg shadow-xl overflow-x-auto max-h-64">
                <h3 class="text-lg font-semibold text-gray-700 mb-2 border-b pb-1">ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
                <table id="dataTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody id="tableBody" class="bg-white divide-y divide-gray-200 text-sm">
                        <tr><td colspan="100" class="text-center py-4 text-gray-500">ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <footer class="bg-gray-800 text-white p-3 text-center text-xs">
        <p>Plotly.js ã¨ Tailwind CSS ã‚’åˆ©ç”¨ã—ãŸã‚°ãƒ©ãƒ•ä½œæˆã‚¢ãƒ—ãƒª</p>
    </footer>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªDOMè¦ç´ å¤‰æ•°
        let rawData = [];
        let headerNames = [];
        let chartInitialized = false;
        
        // FIX: alert()ã®ä»£æ›¿ã¨ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚’è¿½åŠ 
        function displayMessage(message, isError = false) {
            const container = document.getElementById('message-container');
            if (container) {
                const bgColor = isError ? 'bg-red-100 border-red-400 text-red-700' : 'bg-green-100 border-green-400 text-green-700';
                const strongText = isError ? 'ã‚¨ãƒ©ãƒ¼:' : 'æƒ…å ±:';
                container.innerHTML = `
                    <div class="${bgColor} border px-4 py-3 rounded-lg relative shadow-lg" role="alert">
                        <strong class="font-bold">${strongText}</strong>
                        <span class="block sm:inline ml-2">${message}</span>
                        <span class="absolute top-0 bottom-0 right-0 px-4 py-3 cursor-pointer" onclick="document.getElementById('message-container').innerHTML = ''">
                            <svg class="fill-current h-6 w-6 text-indigo-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.03a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.03a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
                        </span>
                    </div>`;
                setTimeout(() => { container.innerHTML = ''; }, 5000);
            } else {
                console.log(message);
            }
        }

        // D4, d2, A2ãªã©ã®å®šæ•° (JIS Z 9021-1:2018ã‚ˆã‚Š)
        const CONTROL_CHART_CONSTANTS = {
            2: { d2: 1.128, A2: 1.880, D4: 3.267, E2: 2.660, c4: 0.7979 },
            3: { d2: 1.693, A2: 1.023, D4: 2.574, E2: 1.772, c4: 0.8862 },
            4: { d2: 2.059, A2: 0.729, D4: 2.282, E2: 1.457, c4: 0.9213 },
            5: { d2: 2.326, A2: 0.577, D4: 2.114, E2: 1.290, c4: 0.9400 },
            6: { d2: 2.534, A2: 0.483, D4: 2.004, E2: 1.184, c4: 0.9515 },
            7: { d2: 2.704, A2: 0.419, D4: 1.924, E2: 1.109, c4: 0.9594 },
            8: { d2: 2.847, A2: 0.373, D4: 1.864, E2: 1.054, c4: 0.9650 },
            9: { d2: 2.970, A2: 0.337, D4: 1.816, E2: 1.009, c4: 0.9693 },
            10: { d2: 3.078, A2: 0.308, D4: 1.777, E2: 0.975, c4: 0.9727 },
        };

        // DOMè¦ç´ 
        let fileInput, chartType, xAxis, yAxis, createChartBtn, downloadChartBtn, yAxisHint, dataTable, tableHeader, tableBody, controlChartParams, subgroupSizeInput;

        document.addEventListener('DOMContentLoaded', async () => {
            // FIX: chartContainer ã®å®£è¨€ã‚’ã“ã“ã§ const ã‹ã‚‰å‰Šé™¤ (ä¸‹ã®downloadChartAsImageã§æ”¹ã‚ã¦å–å¾—ã™ã‚‹ãŸã‚)
            const chartContainer = document.getElementById('chart-container');
            fileInput = document.getElementById('fileInput');
            chartType = document.getElementById('chartType');
            xAxis = document.getElementById('xAxis');
            yAxis = document.getElementById('yAxis');
            createChartBtn = document.getElementById('createChartBtn');
            downloadChartBtn = document.getElementById('downloadChartBtn');
            yAxisHint = document.getElementById('yAxisHint');
            dataTable = document.getElementById('dataTable');
            tableHeader = document.getElementById('tableHeader');
            tableBody = document.getElementById('tableBody');
            controlChartParams = document.getElementById('controlChartParams');
            subgroupSizeInput = document.getElementById('subgroupSize');

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            fileInput.addEventListener('change', handleFile);
            createChartBtn.addEventListener('click', () => createChart(chartContainer));
            chartType.addEventListener('change', toggleControls);
            yAxis.multiple = true; // Yè»¸ã¯è¤‡æ•°é¸æŠå¯èƒ½

            // ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–
            updateAxisOptions();
            toggleControls();
            
            // PlotlyåˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (!chartInitialized) {
                Plotly.newPlot('chart-container', [], {
                    xaxis: { visible: false },
                    yaxis: { visible: false },
                    annotations: [{
                        text: 'ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã€ã‚°ãƒ©ãƒ•ã‚’ä½œæˆã—ã¦ãã ã•ã„',
                        xref: 'paper', yref: 'paper',
                        x: 0.5, y: 0.5,
                        showarrow: false,
                        font: { size: 24, color: '#9ca3af' }
                    }],
                    margin: { t: 50, b: 50, l: 50, r: 50 }
                }, { responsive: true, displayModeBar: false });
                chartInitialized = true;
            }
        });

        function toggleControls() {
            const type = chartType.value;
            const isControlChart = ['xbar', 'rs'].includes(type);

            // X/Yè»¸ã®æœ‰åŠ¹åŒ–
            xAxis.disabled = !rawData.length;
            yAxis.disabled = !rawData.length;
            
            // X-bar/R_sç®¡ç†å›³ã®å ´åˆã€Yè»¸ã¯å˜ä¸€é¸æŠã«å¼·åˆ¶
            if (isControlChart) {
                yAxis.multiple = false;
                yAxisHint.classList.add('hidden');
            } else {
                yAxis.multiple = true;
                yAxisHint.classList.remove('hidden');
            }

            // ç®¡ç†å›³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¡¨ç¤º
            if (isControlChart) {
                controlChartParams.classList.remove('hidden');
            } else {
                controlChartParams.classList.add('hidden');
            }
        }

        function updateAxisOptions(selectedX = null, selectedY = []) {
            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
            xAxis.innerHTML = '<option value="">-- åˆ—ã‚’é¸æŠ --</option>';
            yAxis.innerHTML = '<option value="">-- åˆ—ã‚’é¸æŠ --</option>';
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼åã«åŸºã¥ã„ã¦ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
            headerNames.forEach(header => {
                const xOption = document.createElement('option');
                xOption.value = header;
                xOption.textContent = header;
                if (header === selectedX) xOption.selected = true;
                xAxis.appendChild(xOption);

                const yOption = document.createElement('option');
                yOption.value = header;
                yOption.textContent = header;
                if (selectedY.includes(header)) yOption.selected = true;
                yAxis.appendChild(yOption);
            });
        }

        function handleFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            // FIX: extension ã®å®šç¾©ã‚’ onload ã®å¤–ã«ç§»å‹• (ã‚¹ã‚³ãƒ¼ãƒ—ã®å•é¡Œã‚’è§£æ±º)
            const extension = file.name.split('.').pop().toLowerCase();

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = e.target.result;
                // const extension = file.name.split('.').pop().toLowerCase(); // å…ƒã®ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å‰Šé™¤
                
                try {
                    if (['xlsx', 'xls'].includes(extension)) {
                        processExcel(data);
                    } else if (extension === 'csv') {
                        processCSV(data);
                    } else {
                        displayMessage('ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚', true);
                    }
                    displayMessage(`ãƒ•ã‚¡ã‚¤ãƒ« "${file.name}" ã®ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸã€‚`);
                } catch (error) {
                    console.error("ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:", error);
                    displayMessage('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¾ãŸã¯è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', true);
                }
            };

            if (['xlsx', 'xls'].includes(extension)) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }

        function processExcel(data) {
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[sheetName];
            const json = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            if (json.length === 0) {
                displayMessage('ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', true);
                return;
            }

            headerNames = json[0].map(h => String(h).trim());
            rawData = json.slice(1);
            
            updateAxisOptions();
            displayDataPreview();
        }

        function processCSV(data) {
            Papa.parse(data, {
                header: false,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data.length === 0) {
                        displayMessage('ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚', true);
                        return;
                    }
                    headerNames = results.data[0].map(h => String(h).trim());
                    rawData = results.data.slice(1);

                    updateAxisOptions();
                    displayDataPreview();
                },
                error: function(error) {
                    console.error("CSVè§£æã‚¨ãƒ©ãƒ¼:", error);
                    displayMessage('CSVãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', true);
                }
            });
        }

        function displayDataPreview() {
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡¨ç¤º
            tableHeader.innerHTML = headerNames.map(h => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${h}</th>`).join('');

            // ãƒ‡ãƒ¼ã‚¿æœ¬ä½“è¡¨ç¤º (æœ€åˆã®10è¡Œã¾ã§)
            tableBody.innerHTML = '';
            const previewData = rawData.slice(0, 10);
            if (previewData.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="100" class="text-center py-4 text-gray-500">ãƒ‡ãƒ¼ã‚¿ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</td></tr>';
                 downloadChartBtn.disabled = true;
                 return;
            }

            previewData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = row.map(cell => `<td class="px-6 py-4 whitespace-nowrap">${String(cell)}</td>`).join('');
                tableBody.appendChild(tr);
            });
            
            downloadChartBtn.disabled = false;
        }

        function getColumnData(columnName) {
            const index = headerNames.indexOf(columnName);
            if (index === -1) return [];
            return rawData.map(row => row[index]).filter(v => v !== null && v !== undefined && v !== '');
        }

        function calculateControlChart(data, n, chartType) {
            const constants = CONTROL_CHART_CONSTANTS[n];
            if (!constants) {
                throw new Error(`ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ã‚µã‚¤ã‚º n=${n} ã®ç®¡ç†å›³å®šæ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚`);
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†å‰²
            const subgroups = [];
            for (let i = 0; i < data.length; i += n) {
                subgroups.push(data.slice(i, i + n).map(v => parseFloat(v)).filter(v => !isNaN(v)));
            }
            
            const validSubgroups = subgroups.filter(g => g.length === n);
            if (validSubgroups.length < 2) {
                throw new Error(`æœ‰åŠ¹ãªã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ãŒ2ã¤æœªæº€ã§ã™ (ã‚µã‚¤ã‚º n=${n})ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
            }
            
            let subgroupMeans = [];
            let subgroupRanges = []; // Rs (ç§»å‹•ç¯„å›²) ç”¨

            if (chartType === 'xbar') {
                subgroupMeans = validSubgroups.map(g => g.reduce((a, b) => a + b, 0) / n);
                // Rsãƒãƒ£ãƒ¼ãƒˆã®Rè¨ˆç®—
                subgroupRanges = validSubgroups.map(g => Math.max(...g) - Math.min(...g));
            } else if (chartType === 'rs') {
                // Rsãƒãƒ£ãƒ¼ãƒˆã¯ç§»å‹•ç¯„å›² (Rs) ã®ã¿ã‚’æ‰±ã†
                for (let i = 0; i < validSubgroups.length; i++) {
                    const group = validSubgroups[i];
                    if (i === 0) {
                        subgroupRanges.push(0); // æœ€åˆã®ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ã®ç§»å‹•ç¯„å›²ã¯0
                    } else {
                        const prevGroup = validSubgroups[i - 1];
                        const lastValuePrev = prevGroup[prevGroup.length - 1];
                        const firstValueCurrent = group[0];
                        subgroupRanges.push(Math.abs(firstValueCurrent - lastValuePrev));
                    }
                }
            }


            // å¹³å‡ç¯„å›² $\bar{R}$ ã®è¨ˆç®— (X-bar/R_så…±é€š)
            const Rbar = subgroupRanges.reduce((a, b) => a + b, 0) / subgroupRanges.length;

            let UCL, CL, LCL;

            if (chartType === 'xbar') {
                // $\bar{\bar{X}}$ (XäºŒé‡æ£’) ã®è¨ˆç®—
                const Xdoublebar = subgroupMeans.reduce((a, b) => a + b, 0) / subgroupMeans.length;
                
                CL = Xdoublebar;
                UCL = CL + constants.A2 * Rbar;
                LCL = CL - constants.A2 * Rbar;

                return {
                    CL: CL,
                    UCL: UCL,
                    LCL: LCL,
                    data: subgroupMeans,
                    Rbar: Rbar
                };
            } else if (chartType === 'rs') {
                // R_s (ç§»å‹•ç¯„å›²) ãƒãƒ£ãƒ¼ãƒˆ
                CL = Rbar;
                UCL = constants.D4 * Rbar;
                LCL = 0; // Rsãƒãƒ£ãƒ¼ãƒˆã®ä¸‹é™ç®¡ç†é™ç•Œã¯é€šå¸¸0
                
                return {
                    CL: CL,
                    UCL: UCL,
                    LCL: LCL,
                    data: subgroupRanges
                };
            }
            
            throw new Error('ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ç®¡ç†å›³ã‚¿ã‚¤ãƒ—ã§ã™ã€‚');
        }

        async function createChart(chartContainer) {
            const type = chartType.value;
            const xCol = xAxis.value;
            const yCol = yAxis.value;
            
            if (!xCol || !yCol || !type) {
                displayMessage('Xè»¸ã€Yè»¸ã€ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—ã‚’ã™ã¹ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚', true);
                return;
            }

            try {
                let plotData = [];
                let layout = {};

                // é¸æŠã•ã‚ŒãŸYè»¸ã®åˆ—ã‚’å–å¾—
                const yValues = getColumnData(yCol).map(v => parseFloat(v));
                
                if (yValues.some(isNaN)) {
                    displayMessage('é¸æŠã•ã‚ŒãŸYè»¸ã®åˆ—ã«æ•°å€¤ã§ã¯ãªã„ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚', true);
                    return;
                }

                // Xè»¸ã®ã‚«ãƒ†ã‚´ãƒª/ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
                let xLabels = getColumnData(xCol).slice(0, yValues.length);
                
                // ãƒ‡ãƒ¼ã‚¿æ•°ãŒå°‘ãªã„å ´åˆã®èª¿æ•´
                if (xLabels.length !== yValues.length) {
                    displayMessage('Xè»¸ã¨Yè»¸ã®ãƒ‡ãƒ¼ã‚¿è¡Œæ•°ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€‚', true);
                    return;
                }

                switch (type) {
                    case 'line':
                    case 'scatter':
                        plotData.push({
                            x: xLabels,
                            y: yValues,
                            mode: type === 'line' ? 'lines+markers' : 'markers',
                            type: 'scatter',
                            name: yCol,
                            marker: { size: 8 }
                        });

                        layout = {
                            title: { text: `ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ­ãƒƒãƒˆ (${type})` },
                            xaxis: { title: xCol, automargin: true },
                            yaxis: { title: yCol, automargin: true },
                            margin: { t: 50, b: 50, l: 50, r: 50 },
                            hovermode: 'x unified',
                            legend: { orientation: 'h', y: -0.15, x: 0.5, xanchor: 'center' }
                        };
                        break;
                        
                    case 'bar':
                        plotData.push({
                            x: xLabels,
                            y: yValues,
                            type: 'bar',
                            name: yCol,
                        });
                        
                        layout = {
                            title: { text: `ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ­ãƒƒãƒˆ (${type})` },
                            xaxis: { title: xCol, automargin: true },
                            yaxis: { title: yCol, automargin: true },
                            margin: { t: 50, b: 50, l: 50, r: 50 },
                            legend: { orientation: 'h', y: -0.15, x: 0.5, xanchor: 'center' }
                        };
                        break;

                    case 'histogram':
                        plotData.push({
                            x: yValues, // Yè»¸ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ä½¿ç”¨
                            type: 'histogram',
                            name: yCol,
                        });

                        layout = {
                            title: { text: `ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ  (${yCol})` },
                            xaxis: { title: yCol, automargin: true },
                            yaxis: { title: 'é »åº¦', automargin: true },
                            bargap: 0.05,
                            margin: { t: 50, b: 50, l: 50, r: 50 }
                        };
                        break;

                    case 'xbar':
                    case 'rs':
                        const n = parseInt(subgroupSizeInput.value, 10);
                        if (isNaN(n) || n < 2 || n > 10) {
                            displayMessage('ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ã‚µã‚¤ã‚º n ã¯ 2 ã‹ã‚‰ 10 ã®é–“ã®æ•°å€¤ã§ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã€‚', true);
                            return;
                        }

                        const controlResult = calculateControlChart(yValues, n, type);

                        // Xè»¸ãƒ©ãƒ™ãƒ«ã®æº–å‚™: ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ç•ªå·
                        const subgroupLabels = Array.from({ length: controlResult.data.length }, (_, i) => i + 1);

                        // ç®¡ç†é™ç•Œç·šã®ãƒ‡ãƒ¼ã‚¿
                        const limitTrace = (value, name, color) => ({
                            x: subgroupLabels,
                            y: Array(subgroupLabels.length).fill(value),
                            mode: 'lines',
                            type: 'scatter',
                            name: name,
                            line: { color: color, dash: 'dash' },
                            hoverinfo: 'name+y'
                        });

                        // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ­ãƒƒãƒˆ
                        const dataTrace = {
                            x: subgroupLabels,
                            y: controlResult.data,
                            mode: 'lines+markers',
                            type: 'scatter',
                            name: type === 'xbar' ? '$\bar{X}$ (å¹³å‡)' : '$R_s$ (ç§»å‹•ç¯„å›²)',
                            marker: { size: 8, color: '#3b82f6' },
                            line: { color: '#3b82f6' }
                        };

                        plotData = [
                            limitTrace(controlResult.UCL, 'UCL (ä¸Šé™ç®¡ç†é™ç•Œ)', '#ef4444'),
                            limitTrace(controlResult.CL, 'CL (ä¸­å¿ƒç·š)', '#10b981'),
                            limitTrace(controlResult.LCL, 'LCL (ä¸‹é™ç®¡ç†é™ç•Œ)', '#ef4444'),
                            dataTrace
                        ];

                        layout = {
                            title: { 
                                text: type === 'xbar' ? `$\bar{X}$ ç®¡ç†å›³ (n=${n})` : `$R_s$ ç®¡ç†å›³ (n=${n})` 
                            },
                            xaxis: { 
                                title: 'ã‚µãƒ–ã‚°ãƒ«ãƒ¼ãƒ—ç•ªå·', automargin: true 
                            },
                            yaxis: { 
                                title: type === 'xbar' ? '$\bar{X}$ (å¹³å‡)' : '$R_s$ (ç§»å‹•ç¯„å›²)', automargin: true 
                            },
                            margin: { t: 50, b: 50, l: 50, r: 50 },
                            hovermode: 'x unified',
                            legend: { orientation: 'h', y: -0.15, x: 0.5, xanchor: 'center' }
                        };

                        break;

                    default:
                        displayMessage('ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', true);
                        return;
                }

                // ã‚°ãƒ©ãƒ•æç”»
                await Plotly.newPlot(chartContainer, plotData, layout, { 
                    responsive: true, 
                    displayModeBar: true,
                    modeBarButtonsToRemove: ['lasso2d', 'select2d', 'sendDataToCloud', 'hoverClosestCartesian', 'hoverCompareCartesian'],
                    displaylogo: false
                });

                downloadChartBtn.disabled = false;

            } catch (error) {
                console.error("ã‚°ãƒ©ãƒ•æç”»ã‚¨ãƒ©ãƒ¼:", error);
                displayMessage(`ã‚°ãƒ©ãƒ•ã®æç”»ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, true);
                downloadChartBtn.disabled = true;
            }
        }

        // --- ã‚°ãƒ©ãƒ•ã‚’ç”»åƒã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ---
        function downloadChartAsImage() {
            // FIX: ã‚¹ã‚³ãƒ¼ãƒ—ã®å•é¡Œã§å‚ç…§ã§ããªã„ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° 'chartContainer' 
            // ã®ä»£ã‚ã‚Šã«ã€DOMè¦ç´ ã‚’IDã§ç›´æ¥å–å¾—ã™ã‚‹
            const chartContainerElement = document.getElementById('chart-container');
            
            if (!chartContainerElement || !chartContainerElement.data) {
                // alert()ã®ä»£ã‚ã‚Šã«displayMessageã‚’ä½¿ç”¨
                displayMessage('ã‚°ãƒ©ãƒ•ãŒã¾ã æç”»ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‰ã«ã‚°ãƒ©ãƒ•ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚', true);
                return;
            }

            const now = new Date();
            const filename = `chart_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}.png`;

            //Plotly.downloadImage(chartContainer, {
            Plotly.downloadImage(chartContainerElement, { // FIX: ç¢ºå®Ÿã«å–å¾—ã—ãŸè¦ç´ ã‚’ä½¿ç”¨
                format: 'png',
                filename: filename, 
                width: 1200,
                height: 750
            }).catch(err => {
                console.error('ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', err);
                // FIX: alert()ã‚’displayMessageã«ç½®ãæ›ãˆã‚‹ (å¿…é ˆãƒ«ãƒ¼ãƒ«)
                displayMessage('ã‚°ãƒ©ãƒ•ç”»åƒã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚°ãƒ©ãƒ•ãŒæ­£ã—ãæç”»ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', true);
            });
        }

        
        // ã‚°ãƒ©ãƒ•ã‚’PNGã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ (ã“ã®é–¢æ•°ã¯ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã°ã‚Œã¦ã„ãªã„ãŸã‚ã€ä¿®æ­£ã¯ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿)
        function handleDownload() {
             const chartContainerElement = document.getElementById('chart-container'); // ã“ã“ã‚‚ä¿®æ­£
            // Plotly.jsã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’ä½¿ç”¨
            Plotly.downloadImage(chartContainerElement, {
                format: 'png',
                filename: 'chart_download',
                height: 600,
                width: 900
            }).catch(error => {
                console.error("ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:", error);
                // FIX: alert()ã‚’displayMessageã«ç½®ãæ›ãˆã‚‹ (å¿…é ˆãƒ«ãƒ¼ãƒ«)
                displayMessage('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚', true);
            });
        }
    </script>
</body>
</html>
